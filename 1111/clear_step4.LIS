                         4 .list
                         5 ***************************************************************
                         6 		**各種レジスタ定義
                         7 		***************************************************************
                         8 
                         9 		***************
                        10 		** レジスタ群の先頭
                        11 		***************
                        12 		.equ REGBASE,   0xFFF000          | DMAPを使用．
                        13 		.equ IOBASE,    0x00d00000
                        14 
                        15 		***************
                        16 		** 割り込み関係のレジスタ
                        17 		***************
                        18 		.equ IVR,       REGBASE+0x300     |割り込みベクタレジスタ
                        19 		.equ IMR,       REGBASE+0x304     |割り込みマスクレジスタ
                        20 		.equ ISR,       REGBASE+0x30c     |割り込みステータスレジスタ
                        21 		.equ IPR,       REGBASE+0x310     |割り込みペンディングレジスタ
                        22 
                        23 		***************
                        24 		** タイマ関係のレジスタ
                        25 		***************
                        26 		.equ TCTL1,     REGBASE+0x600     |タイマ１コントロールレジスタ
                        27 		.equ TPRER1,    REGBASE+0x602     |タイマ１プリスケーラレジスタ
                        28 		.equ TCMP1,     REGBASE+0x604     |タイマ１コンペアレジスタ
                        29 		.equ TCN1,      REGBASE+0x608     |タイマ１カウンタレジスタ
                        30 		.equ TSTAT1,    REGBASE+0x60a     |タイマ１ステータスレジスタ
                        31 
                        32 		***************
                        33 		** UART1（送受信）関係のレジスタ
                        34 		***************
                        35 		.equ USTCNT1,   REGBASE+0x900     | UART1ステータス/コントロールレジスタ
                        36 		.equ UBAUD1,    REGBASE+0x902     | UART1ボーコントロールレジスタ
                        37 		.equ URX1,      REGBASE+0x904     | UART1受信レジスタ
                        38 		.equ UTX1,      REGBASE+0x906     | UART1送信レジスタ
                        39 
                        40 		***************
                        41 		** LED
                        42 		***************
                        43 		.equ LED7,      IOBASE+0x000002f  |ボード搭載のLED用レジスタ
                        44 		.equ LED6,      IOBASE+0x000002d  |使用法については付録A.4.3.1
                        45 		.equ LED5,      IOBASE+0x000002b
                        46 		.equ LED4,      IOBASE+0x0000029
                        47 		.equ LED3,      IOBASE+0x000003f
                        48 		.equ LED2,      IOBASE+0x000003d
                        49 		.equ LED1,      IOBASE+0x000003b
                        50 		.equ LED0,      IOBASE+0x0000039
                        51 
                        52 		***************************************************************
                        53 		** スタック領域の確保
                        54 		***************************************************************
                        55 		.section .bss
                        56 		.even
                        57 SYS_STK:
000808 0000 0000        58 		.ds.b   0x4000  |システムスタック領域
       0000 0000        58 
       0000 0000        58 
       0000 0000        58 
       0000 0000        58 
                        59 		.even
                        60 SYS_STK_TOP:            |システムスタック領域の最後尾
                        61 
                        62 		***************************************************************
                        63 		** 初期化
                        64 		** 内部デバイスレジスタには特定の値が設定されている．
                        65 		** その理由を知るには，付録Bにある各レジスタの仕様を参照すること．
                        66 		***************************************************************
                        67 		.section .text
                        68 		.even
                        69 boot:
                        70 		* スーパーバイザ&各種設定を行っている最中の割込禁止
000400 46FC 2700        71 		move.w #0x2700,%SR
000404 4FF9 0000        72 		lea.l  SYS_STK_TOP, %SP | Set SSP
       0000             72 
                        73 
                        74 		****************
                        75 		**割り込みコントローラの初期化
                        76 		****************
00040a 13FC 0040        77 		move.b #0x40, IVR       |ユーザ割り込みベクタ番号を| 0x40+levelに設定．
       00FF F300        77 
000412 23FC 00FF        78 		move.l #0x00ffffff,IMR  |全割り込みマスク /* STEP2.3 */
       FFFF 00FF        78 
       F304             78 
00041c 4EB9 0000        79 		jsr Init_Q
       0000             79 
                        80 
                        81 		****************
                        82 		** 送受信(UART1)関係の初期化(割り込みレベルは4に固定されている)
                        83 		****************
000422 33FC 0000        84 		move.w #0x0000, USTCNT1 |リセット
       00FF F900        84 
00042a 33FC E100        85 		move.w #0xe100, USTCNT1 |送受信可能,パリティなし, 1 stop, 8 bit,|送受割り込み禁
       00FF F900        85 
000432 33FC 0038        86 		move.w #0x0038, UBAUD1  |baud rate = 230400 bps
       00FF F902        86 
                        87 
                        88 		****************
                        89 		** タイマ関係の初期化(割り込みレベルは6に固定されている)
                        90 		*****************
00043a 33FC 0004        91 		move.w #0x0004, TCTL1   | restart,割り込み不可,|システムクロックの1/16を単位と
       00FF F600        91 
                        92 
                        93 		***************************************************************
                        94 		** STEP2の処理
                        95 		***************************************************************
                        96 		*lea.l uart1_interrupt, %a0
                        97 		*move.l %a0, 0x110 /* STEP2.1 level 4, (64+4)*4 割り込み処理ルーチンの開始アドレ
                        98 
                        99 
                       100 
                       101 
000442 21FC 0000       102 		move.l #uart1_interrupt, 0x110
       0000 0110       102 
00044a 33FC E108       103 		move.w #0xe108, USTCNT1 |受信割り込み許可、送信割り込み無効 /* STEP2.2 */
       00FF F900       103 
000452 23FC 00FF       104 		move.l #0x00ff3ffb,IMR  |受信割り込みマスク /* STEP2.3 */
       3FFB 00FF       104 
       F304            104 
00045c 46FC 2000       105 		move.w #0x2000, %SR    /* STEP2.4 割り込み許可．(スーパーバイザモードの場合) 
                       106 
000460 6000 0002       107 		bra MAIN
                       108 
                       109 		***************************************************************
                       110 		** 現段階での初期化ルーチンの正常動作を確認するため，最後に’a’を
                       111 		** 送信レジスタUTX1に書き込む．'a'が出力されれば，OK.
                       112 		***************************************************************
                       113 		.section .text
                       114 		.even
                       115 
                       116 
                       117 
                       118 
                       119 	
                       120 MAIN:
                       121 		*move.w #0x0800+'a', UTX1 | 0x0800を足す理由については，|付録参照
                       122 
                       123 
                       124 
000464 4EBA 0006       125 		jsr TEST_READY
                       126 		
                       127 LOOP:
000468 6000 FFFE       128 		bra LOOP
                       129 
                       130 /*以下テスト*/
                       131 TEST_READY:
                       132 	
00046c 383C 0010       133 		move.w #16, %d4
000470 3A3C 0010       134 		move.w #16, %d5
000474 123C 0061       135 		move.b #0x61, %d1
000478 6000 0008       136 		bra TEST_LOOP
                       137 
                       138 TEST_LOOP2:
                       139 
00047c 5241            140 		addq #1, %d1
00047e 383C 0010       141 		move.w #16, %d4
                       142 
                       143 TEST_LOOP:
000482 7000            144 		move.l #0, %d0
000484 4EB9 0000       145 		jsr INQ
       0000            145 
00048a 5344            146 		subq #1, %d4
00048c 6600 FFF4       147 		bne TEST_LOOP
000490 5345            148 		subq #1, %d5
000492 6700 0006       149 		beq TEST_END
000496 6000 FFE4       150 		bra TEST_LOOP2
                       151 
                       152 TEST_END:
00049a 4E75            153 		rts
                       154 /*以上テスト*/
                       155 
                       156 uart1_interrupt:
00049c 48E7 8000       157 		movem.l %d0, -(%sp)
                       158 
                       159 
                       160 
0004a0 3039 00FF       161 		move.w UTX1, %d0	/*step4:UTX1のコピー*/
       F906            161 
                       162 		
0004a6 7200            163 		move.l #0, %d1	/*chの選択*/
                       164 
0004a8 0C40 8000       165 		cmp.w #0x8000,%d0
0004ac 6400 0008       166 		bcc INTERPUT
                       167 
                       168 INTERPUT_RTE:
0004b0 4CDF 0001       169 		movem.l (%sp)+, %d0
                       170 
0004b4 4E73            171 		rte
                       172 
                       173 
                       174 INTERPUT:
0004b6 7201            175 	move.l #1, %d1
                       176 
0004b8 46FC 2700       177 	move.w #0x2700, %SR	/*step4.1:走行レベル7*/
                       178 	
0004bc 0C81 0000       179 	cmp.l #0x0, %d1		/*step4.2:ch!=0で分岐*/
       0000            179 
                       180 
0004c2 6600 0022       181 	bne INTERPUT_END
                       182 
0004c6 7001            183 	move.l #1, %d0
0004c8 4EB9 0000       184 	jsr OUTQ		/*step4.3:OUTQの実行*/
       0000            184 
                       185 
0004ce 0C80 0000       186 	cmp.l #0, %d0		/*step4.4:戻り値が0で分岐*/
       0000            186 
0004d4 6700 0014       187 	beq INTERPUT_MASK
                       188 
0004d8 123C 0061       189 	move.b #'a', %d1
0004dc 0641 0800       190 	addi.w #0x0800, %d1
0004e0 33C1 00FF       191 	move.w %d1, UTX1	/*step4.5:ヘッダ付与*/
       F906            191 
                       192 
                       193 
                       194 INTERPUT_END:
0004e6 4EFA FFC8       195 	jmp INTERPUT_RTE
                       196 
                       197 INTERPUT_MASK:
                       198 	
0004ea 23FC 00FF       199 	move.l #0xff3ffb, IMR	/*step4.4:送信割り込みのマスク : 割り込み選択レジスタを
       3FFB 00FF       199 
       F304            199 
                       200 
0004f4 123C 005A       201 	move.b #'Z', %d1
0004f8 0641 0800       202 	addi.w #0x0800, %d1
0004fc 33C1 00FF       203 	move.w %d1, UTX1
       F906            203 
                       204 
                       205 
000502 6000 FFE2       206 	bra INTERPUT_END
                       207 
                       208 
                       209 *******************************************************
                       210 ** 						QUEUE (TA)
                       211 *******************************************************
                       212 
                       213 
                       214 .section .data
                       215 .equ TOP, 0
                       216 .equ BOTTOM, 4
                       217 .equ IN, 8
                       218 .equ OUT, 12
                       219 .equ S, 16
                       220 .equ DATA_TOP, 18
                       221 .equ DATA_LEN, 256
                       222 .equ QUEUE_SIZE, DATA_TOP + DATA_LEN /* 18 + 256 = 274 */
                       223 
000508 0000 0000       224 QUEUE_TOP: ds.b QUEUE_SIZE * 2
       0000 0000       224 
       0000 0000       224 
       0000 0000       224 
       0000 0000       224 
                       225 
                       226 /* 初期化 */
                       227 ********************
                       228 * 初期化
                       229 ********************
                       230 
                       231 Init_Q:
00072c 48E7 C0E0       232     movem.l %d0-%d1/%a0-%a2, -(%sp) /* 使用レジスタの退避 */
                       233 
000730 7000            234     move.l #0, %d0 /* キュー番号 = 0 */
                       235 
                       236 Init_Q_sub:
000732 41FA FDD4       237     lea.l QUEUE_TOP, %a0 /* キューの先頭アドレス */
000736 2200            238     move.l %d0, %d1
000738 C2F8 0112       239     mulu.w QUEUE_SIZE, %d1 /* キューnの相対先頭アドレス = n * (キューサイズ) */
00073c D1C1            240     add.l %d1, %a0 /* a0 = キューnの先頭アドレス */
00073e 43E8 0012       241     lea.l DATA_TOP(%a0), %a1 /* a1 = キューnのデータ領域先頭アドレス = DATA_TOP + a0
000742 2089            242     move.l %a1, TOP(%a0) /* キューnのTOPのアドレス = a0 + TOP であるのでそこにa1
000744 2149 0008       243     move.l %a1, IN(%a0) /* キューnのINのアドレスにa1を格納 */
000748 2149 000C       244     move.l %a1, OUT(%a0) /* キューnのOUTのアドレスにa1を格納 */
00074c 43E8 0004       245     lea.l BOTTOM(%a0), %a1 /* a1 = キューnのBOTTOMのアドレス */
000750 43E8 0111       246     lea.l QUEUE_SIZE-1(%a0), %a1 /* a1 == BOTTOM = キューnの終端アドレス */
000754 317C 0000       247     move.w #0, S(%a0) /* データ数 = 0 */
       0010            247 
00075a 5280            248     addq.l #1, %d0 /* キュー番号++ */
00075c 0C80 0000       249     cmpi.l #2, %d0 /* キューの個数分(2)ループ */
       0002            249 
000762 6600 FFCE       250     bne Init_Q_sub
                       251 
000766 4CDF 0703       252     movem.l (%sp)+, %d0-%d1/%a0-%a2 /* 使用レジスタの復帰 */
00076a 4E75            253     rts
                       254 
                       255 
                       256 *****************
                       257 ** INQ
                       258 *****************
                       259 
                       260 **************************************
                       261 **入力
                       262 **  d0:キューの選択 [long]
                       263 **  d1:書き込むデータ [long]
                       264 **出力
                       265 **  d0:成功(1)or失敗(0) [long]
                       266 **************************************
                       267 INQ:
                       268 
                       269     /* 現走行レベルの退避 */
00076c 40E7            270     move.w %SR, -(%sp)
                       271 
                       272     /* 割り込み禁止 */
00076e 46FC 2700       273     move.w #0x2700, %SR
                       274 
000772 48E7 00C0       275     movem.l %a0-%a1, -(%sp)
000776 41FA FD90       276     lea.l QUEUE_TOP, %a0 /* a0 = キュー0の先頭アドレス */
00077a C0F8 0112       277     mulu.w QUEUE_SIZE, %d0 /* キューnの相対先頭アドレス = n * (キューサイズ) */
00077e D1C0            278     add.l %d0, %a0 /* a0 = キューnの先頭アドレス */
                       279 
000780 0C68 0100       280     cmpi.w #256, S(%a0)
       0010            280 
000786 6600 0008       281     bne INQ_1
                       282 
                       283     /* S == 256のときd0 = 0(失敗) としてENDへ */
00078a 7000            284     move.l #0, %d0
00078c 6000 0024       285     bra INQ_END
                       286 
                       287 INQ_1:
000790 2268 0008       288     movea.l IN(%a0), %a1 /* a1 = in */
000794 1281            289     move.b %d1, (%a1) /* q[in] = d1 */ 
                       290 
000796 B3E8 0004       291     cmpa.l BOTTOM(%a0), %a1 /* in == bottom かを判定 */
00079a 6600 000A       292     bne INQ_ELSE
                       293 
                       294     /* in == bottom のとき*/
00079e 2150 0008       295     move.l TOP(%a0), IN(%a0) /* in = top */
0007a2 6000 0008       296     bra INQ_2
                       297 
                       298 /* in != bottom のとき*/
                       299 INQ_ELSE:
0007a6 5289            300     addq.l #1, %a1 /* a1++ */
0007a8 2149 0008       301     move.l %a1, IN(%a0) /* in = a1 */
                       302 
                       303 /* s++, d0 = 1(成功) としてENDへ */
                       304 INQ_2:
0007ac 5268 0010       305     addq.w #1, S(%a0)
0007b0 7001            306     move.l #1, %d0
                       307 
                       308 /* 使用レジスタの復帰 */
                       309 INQ_END:
0007b2 4CDF 0300       310     movem.l (%sp)+, %a0-%a1 
0007b6 46DF            311     move.w (%sp)+, %SR
0007b8 4E75            312     rts
                       313 
                       314 
                       315 *****************
                       316 * OUTQ
                       317 *****************
                       318 
                       319 **********************************************
                       320 **入力
                       321 **  d0:キューの選択  [long]
                       322 
                       323 **出力
                       324 **  d0:成功(1)or失敗(0) [long]
                       325 **  d1:取り組んだデータ [byte]
                       326 **********************************************
                       327 OUTQ:
                       328     /* 現走行レベルの退避 */
0007ba 40E7            329     move.w %SR, -(%sp)
                       330 
                       331     /* 割り込み禁止 */
0007bc 46FC 2700       332     move.w #0x2700, %SR
                       333 
0007c0 48E7 00C0       334     movem.l %a0-%a1, -(%sp)
0007c4 41FA FD42       335     lea.l QUEUE_TOP, %a0 /* a0 = キュー0の先頭アドレス */
0007c8 C0F8 0112       336     mulu.w QUEUE_SIZE, %d0 /* キューnの相対先頭アドレス = n * (キューサイズ) */
0007cc D1C0            337     add.l %d0, %a0 /* a0 = キューnの先頭アドレス */
                       338 
0007ce 0C68 0000       339     cmpi.w #0, S(%a0)
       0010            339 
0007d4 6600 0008       340     bne OUTQ_1
                       341 
                       342     /* S == 0のときd0 = 0(失敗) としてENDへ */
0007d8 7000            343     move.l #0, %d0
0007da 6000 0024       344     bra OUTQ_END
                       345 
                       346 OUTQ_1:
0007de 2268 000C       347     movea.l OUT(%a0), %a1 /* a1 = out */
0007e2 1211            348     move.b (%a1), %d1 /* d1 = q[out] */
                       349 
0007e4 B3E8 0004       350     cmpa.l BOTTOM(%a0), %a1 /* out == bottom かを判定 */
0007e8 6600 000A       351     bne OUTQ_ELSE
                       352 
                       353     /* out == bottom のとき*/
0007ec 2150 000C       354     move.l TOP(%a0), OUT(%a0) /* out = top */
0007f0 6000 0008       355     bra OUTQ_2
                       356 
                       357 /* out != bottom のとき*/
                       358 OUTQ_ELSE:
0007f4 5289            359     addq.l #1, %a1 /* a1++ */
0007f6 2149 000C       360     move.l %a1, OUT(%a0) /* out = a1 */
                       361 
                       362 /* s--, d0 = 1(成功) としてENDへ */
                       363 OUTQ_2:
0007fa 5368 0010       364     subq.w #1, S(%a0)
0007fe 7001            365     move.l #1, %d0
                       366 
                       367 /* 使用レジスタの復帰 */
                       368 OUTQ_END:
000800 4CDF 0300       369     movem.l (%sp)+, %a0-%a1 
000804 46DF            370     move.w (%sp)+, %SR
000806 4E75            371     rts
                       372 
                       373 
                       374 
                       375 
                       376 
                       377 
                       378 
