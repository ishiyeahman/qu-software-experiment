                         4 .list
                         5 		***************************************************************
                         6 		**ÂêÑÁ®Æ„É¨„Ç∏„Çπ„ÇøÂÆöÁæ©
                         7 		***************************************************************
                         8 
                         9 		***************
                        10 		** „É¨„Ç∏„Çπ„ÇøÁæ§„ÅÆÂÖàÈ†≠
                        11 		***************
                        12 		.equ REGBASE,   0xFFF000          | DMAP„Çí‰ΩøÁî®Ôºé
                        13 		.equ IOBASE,    0x00d00000
                        14 
                        15 		***************
                        16 		** Ââ≤„ÇäËæº„ÅøÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø
                        17 		***************
                        18 		.equ IVR,       REGBASE+0x300     |Ââ≤„ÇäËæº„Åø„Éô„ÇØ„Çø„É¨„Ç∏„Çπ„Çø
                        19 		.equ IMR,       REGBASE+0x304     |Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ„É¨„Ç∏„Çπ„Çø
                        20 		.equ ISR,       REGBASE+0x30c     |Ââ≤„ÇäËæº„Åø„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
                        21 		.equ IPR,       REGBASE+0x310     |Ââ≤„ÇäËæº„Åø„Éö„É≥„Éá„Ç£„É≥„Ç∞„É¨„Ç∏„Çπ„Çø
                        22 
                        23 		***************
                        24 		** „Çø„Ç§„ÉûÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø
                        25 		***************
                        26 		.equ TCTL1,     REGBASE+0x600     |„Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        27 		.equ TPRER1,    REGBASE+0x602     |„Çø„Ç§„ÉûÔºë„Éó„É™„Çπ„Ç±„Éº„É©„É¨„Ç∏„Çπ„Çø
                        28 		.equ TCMP1,     REGBASE+0x604     |„Çø„Ç§„ÉûÔºë„Ç≥„É≥„Éö„Ç¢„É¨„Ç∏„Çπ„Çø
                        29 		.equ TCN1,      REGBASE+0x608     |„Çø„Ç§„ÉûÔºë„Ç´„Ç¶„É≥„Çø„É¨„Ç∏„Çπ„Çø
                        30 		.equ TSTAT1,    REGBASE+0x60a     |„Çø„Ç§„ÉûÔºë„Çπ„ÉÜ„Éº„Çø„Çπ„É¨„Ç∏„Çπ„Çø
                        31 
                        32 		***************
                        33 		** UART1ÔºàÈÄÅÂèó‰ø°ÔºâÈñ¢‰øÇ„ÅÆ„É¨„Ç∏„Çπ„Çø
                        34 		***************
                        35 		.equ USTCNT1,   REGBASE+0x900     | UART1„Çπ„ÉÜ„Éº„Çø„Çπ/„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        36 		.equ UBAUD1,    REGBASE+0x902     | UART1„Éú„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„É¨„Ç∏„Çπ„Çø
                        37 		.equ URX1,      REGBASE+0x904     | UART1Âèó‰ø°„É¨„Ç∏„Çπ„Çø
                        38 		.equ UTX1,      REGBASE+0x906     | UART1ÈÄÅ‰ø°„É¨„Ç∏„Çπ„Çø
                        39 
                        40 		***************
                        41 		** LED
                        42 		***************
                        43 		.equ LED7,      IOBASE+0x000002f  |„Éú„Éº„ÉâÊê≠Ëºâ„ÅÆLEDÁî®„É¨„Ç∏„Çπ„Çø
                        44 		.equ LED6,      IOBASE+0x000002d  |‰ΩøÁî®Ê≥ï„Å´„Å§„ÅÑ„Å¶„ÅØ‰ªòÈå≤A.4.3.1
                        45 		.equ LED5,      IOBASE+0x000002b
                        46 		.equ LED4,      IOBASE+0x0000029
                        47 		.equ LED3,      IOBASE+0x000003f
                        48 		.equ LED2,      IOBASE+0x000003d
                        49 		.equ LED1,      IOBASE+0x000003b
                        50 		.equ LED0,      IOBASE+0x0000039
                        51 
                        52 		***************************************************************
                        53 		** „Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆÁ¢∫‰øù
                        54 		***************************************************************
                        55 		.section .bss
                        56 		.even
                        57 SYS_STK:
0008b0 0000 0000        58 		.ds.b   0x4000  |„Ç∑„Çπ„ÉÜ„É†„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü
       0000 0000        58 
       0000 0000        58 
       0000 0000        58 
       0000 0000        58 
                        59 		.even
                        60 SYS_STK_TOP:            |„Ç∑„Çπ„ÉÜ„É†„Çπ„Çø„ÉÉ„ÇØÈ†òÂüü„ÅÆÊúÄÂæåÂ∞æ
                        61 
                        62 		***************************************************************
                        63 		** ÂàùÊúüÂåñ
                        64 		** ÂÜÖÈÉ®„Éá„Éê„Ç§„Çπ„É¨„Ç∏„Çπ„Çø„Å´„ÅØÁâπÂÆö„ÅÆÂÄ§„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÔºé
                        65 		** „Åù„ÅÆÁêÜÁî±„ÇíÁü•„Çã„Å´„ÅØÔºå‰ªòÈå≤B„Å´„ÅÇ„ÇãÂêÑ„É¨„Ç∏„Çπ„Çø„ÅÆ‰ªïÊßò„ÇíÂèÇÁÖß„Åô„Çã„Åì„Å®Ôºé
                        66 		***************************************************************
                        67 
                        68 
                        69 .section .data
                        70 .even
000588 3031 3233        71 	TDATA1: .ascii "0123456789ABCDEF"
       3435 3637        71 
       3839 4142        71 
       4344 4546        71 
000598 6B6C 6D6E        72 	TDATA2: .ascii "klmnopqrstuvwxyz"
       6F70 7172        72 
       7374 7576        72 
       7778 797A        72 
                        73 .even
                        74 
                        75 		
                        76 
                        77 .section .text
                        78 		.even
                        79 boot:
                        80 		* „Çπ„Éº„Éë„Éº„Éê„Ç§„Ç∂&ÂêÑÁ®ÆË®≠ÂÆö„ÇíË°å„Å£„Å¶„ÅÑ„ÇãÊúÄ‰∏≠„ÅÆÂâ≤ËæºÁ¶ÅÊ≠¢
000400 46FC 2700        81 		move.w #0x2700,%SR
000404 4FF9 0000        82 		lea.l  SYS_STK_TOP, %SP | Set SSP
       0000             82 
                        83 
                        84 		****************
                        85 		**Ââ≤„ÇäËæº„Åø„Ç≥„É≥„Éà„É≠„Éº„É©„ÅÆÂàùÊúüÂåñ
                        86 		****************
00040a 13FC 0040        87 		move.b #0x40, IVR       |„É¶„Éº„Ç∂Ââ≤„ÇäËæº„Åø„Éô„ÇØ„ÇøÁï™Âè∑„Çí| 0x40+level„Å´Ë®≠ÂÆöÔºé
       00FF F300        87 
000412 23FC 00FF        88 		move.l #0x00ffffff,IMR  |ÂÖ®Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ /* STEP2.3 */
       FFFF 00FF        88 
       F304             88 
                        89 
                        90 		****************
                        91 		** ÈÄÅÂèó‰ø°(UART1)Èñ¢‰øÇ„ÅÆÂàùÊúüÂåñ(Ââ≤„ÇäËæº„Åø„É¨„Éô„É´„ÅØ4„Å´Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã)
                        92 		****************
00041c 33FC 0000        93 		move.w #0x0000, USTCNT1 |„É™„Çª„ÉÉ„Éà
       00FF F900        93 
000424 33FC E100        94 		move.w #0xe100, USTCNT1 |ÈÄÅÂèó‰ø°ÂèØËÉΩ,„Éë„É™„ÉÜ„Ç£„Å™„Åó, 1 stop, 8 bit,|ÈÄÅÂèóÂâ≤„ÇäËæº„ÅøÁ¶Å
       00FF F900        94 
00042c 33FC 0038        95 		move.w #0x0038, UBAUD1  |baud rate = 230400 bps
       00FF F902        95 
                        96 
                        97 		****************
                        98 		** „Çø„Ç§„ÉûÈñ¢‰øÇ„ÅÆÂàùÊúüÂåñ(Ââ≤„ÇäËæº„Åø„É¨„Éô„É´„ÅØ6„Å´Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã)
                        99 		*****************
000434 33FC 0004       100 		move.w #0x0004, TCTL1   | restart,Ââ≤„ÇäËæº„Åø‰∏çÂèØ,|„Ç∑„Çπ„ÉÜ„É†„ÇØ„É≠„ÉÉ„ÇØ„ÅÆ1/16„ÇíÂçò‰Ωç„Å®
       00FF F600       100 
                       101 
                       102 		***************************************************************
                       103 		** STEP2„ÅÆÂá¶ÁêÜ
                       104 		***************************************************************
                       105 		/* ÂàùÊúüÂåñÂá¶ÁêÜ„Çí„É°„Ç§„É≥„É´„Éº„ÉÅ„É≥„Åã„Çâ„Åì„Å°„Çâ„Å∏ÁßªÂãï */
                       106 		*lea.l uart1_interrupt, %a0
                       107 		*move.l %a0, 0x110 /* STEP2.1 level 4, (64+4)*4 Ââ≤„ÇäËæº„ÅøÂá¶ÁêÜ„É´„Éº„ÉÅ„É≥„ÅÆÈñãÂßã„Ç¢„Éâ„É¨„
00043c 21FC 0000       108 		move.l #uart1_interrupt, 0x110
       0000 0110       108 
000444 33FC E100       109 		move.w #0xe100, USTCNT1 |ÈÄÅÂèó‰ø°Ââ≤„ÇäËæº„Åø„Éû„Çπ„ÇØ
       00FF F900       109 
00044c 23FC 00FF       110 		move.l #0x00ff3ffb,IMR  |UART1Ë®±ÂèØ
       3FFB 00FF       110 
       F304            110 
000456 46FC 2700       111 		move.w #0x2700, %SR    /* Ëµ∞Ë°å„É¨„Éô„É´7 */
                       112 		
                       113 
00045a 6000 0002       114 		bra MAIN
                       115 
                       116 		***************************************************************
                       117 		** ÁèæÊÆµÈöé„Åß„ÅÆÂàùÊúüÂåñ„É´„Éº„ÉÅ„É≥„ÅÆÊ≠£Â∏∏Âãï‰Ωú„ÇíÁ¢∫Ë™ç„Åô„Çã„Åü„ÇÅÔºåÊúÄÂæå„Å´‚Äôa‚Äô„Çí
                       118 		** ÈÄÅ‰ø°„É¨„Ç∏„Çπ„ÇøUTX1„Å´Êõ∏„ÅçËæº„ÇÄÔºé'a'„ÅåÂá∫Âäõ„Åï„Çå„Çå„Å∞ÔºåOK.
                       119 		***************************************************************
                       120 		.section .text
                       121 		.even
                       122 
                       123 
                       124 
                       125 
                       126 	
                       127 MAIN:
00045e 4EB9 0000       128 		jsr Init_Q
       0000            128 
000464 13FC 0031       129 		move.b #'1', LED7
       00D0 002F       129 
00046c 33FC E108       130 		move.w #0xe108,USTCNT1
       00FF F900       130 
000474 46FC 2000       131 		move.w #0x2000, %SR    /* Ëµ∞Ë°å„É¨„Éô„É´0 */
                       132 
                       133 
                       134 PS_TEST1:
                       135 		/* jsr PUTSTRING(0, #TDATA1, 16)*/
000478 7200            136 		move.l	#0x00, %d1
00047a 243C 0000       137 		move.l	#TDATA1, %d2
       0000            137 
000480 7610            138 		move.l	#0x10, %d3
000482 4EBA 00A4       139 		jsr PUTSTRING
                       140 		
                       141 	
000486 13FC 0032       142 		move.b #'2', LED6
       00D0 002D       142 
00048e 283C 0000       143 		move.l	#0x000fff, %d4
       0FFF            143 
                       144 	
                       145 		
                       146 LOOP:
000494 5384            147 		subq.l #1,%d4
000496 6700 000E       148 		beq PS_TEST2
00049a 13FC 0035       149 		move.b #'5', LED3
       00D0 003F       149 
                       150 		
0004a2 6000 FFF0       151 		bra LOOP
                       152 
                       153 PS_TEST2:
0004a6 13FC 0036       154 		move.b #'6', LED2
       00D0 003D       154 
0004ae 7200            155 		move.l	#0x00, %d1
0004b0 243C 0000       156 		move.l	#TDATA2, %d2
       0000            156 
0004b6 7610            157 		move.l	#0x010, %d3
0004b8 4EBA 006E       158 		jsr PUTSTRING
0004bc 6000 FFE8       159 		bra PS_TEST2
                       160 
                       161 
                       162 uart1_interrupt:
                       163 		
0004c0 48E7 8000       164 		movem.l %d0, -(%sp)
                       165 		
0004c4 3039 00FF       166 		move.w UTX1, %d0	/*step4:UTX1„ÅÆ„Ç≥„Éî„Éº*/
       F906            166 
0004ca 7200            167 		move.l #0, %d1	/*ch„ÅÆÈÅ∏Êäû*/
                       168 
0004cc 0C40 8000       169 		cmp.w #0x8000,%d0
0004d0 6400 0008       170 		bcc INTERPUT
                       171 
0004d4 4CDF 0001       172 		movem.l (%sp)+, %d0
                       173 		
0004d8 4E73            174 		rte
                       175 
                       176 
                       177 INTERPUT:
0004da 48E7 E000       178 		movem.l %d0-%d2, -(%sp)
                       179 
0004de 46FC 2700       180 		move.w #0x2700, %SR	/*step4.1:Ëµ∞Ë°å„É¨„Éô„É´7*/
                       181 
0004e2 0C81 0000       182 		cmp.l #0x0, %d1		/*step4.2:ch!=0„ÅßÂàÜÂ≤ê*/
       0000            182 
                       183 
0004e8 6600 0030       184 		bne INTERPUT_END
                       185 
0004ec 7001            186 		move.l #1, %d0
                       187 
0004ee 4EB9 0000       188 		jsr OUTQ		/*step4.3:OUTQ„ÅÆÂÆüË°å*/
       0000            188 
                       189 
0004f4 0C80 0000       190 		cmp.l #0, %d0		/*step4.4:Êàª„ÇäÂÄ§„Åå0„ÅßÂàÜÂ≤ê*/
       0000            190 
0004fa 6700 0012       191 		beq INTERPUT_MASK
                       192 
0004fe 1401            193 		move.b %d1, %d2
000500 0642 0800       194 		addi.w #0x0800, %d2
000504 33C2 00FF       195 		move.w %d2, UTX1	/*step4.5:„Éò„ÉÉ„ÉÄ‰ªò‰∏é*/
       F906            195 
                       196 
00050a 6000 000E       197 		bra INTERPUT_END
                       198 INTERPUT_MASK:
00050e 33FC E108       199 		move.w #0xe108, USTCNT1	/*step4.4:ÈÄÅ‰ø°Ââ≤„ÇäËæº„Åø„ÅÆ„Éû„Çπ„ÇØ*/
       00FF F900       199 
                       200 		/* ‚Üë ‰ΩïÊïÖ„Åã„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà„Åï„Çå„Å¶„ÅÑ„Åü„ÅÆ„Åß„ÄÅ‰øÆÊ≠£ */
                       201 
000516 6000 0002       202 		bra INTERPUT_END
                       203 
                       204 
                       205 INTERPUT_END:
00051a 13FC 0033       206 		move.b #'3', LED5
       00D0 002B       206 
000522 4CDF 0007       207 		movem.l (%sp)+, %d0-%d2
                       208 
                       209 
000526 4E73            210 		rte
                       211 
                       212 
                       213 *************************************************************
                       214 **PUTSTRING
                       215 **ÂÖ•Âäõ
                       216 **d1:„ÉÅ„É£„Éç„É´
                       217 **d2:„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ
                       218 **d3:ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„ÇøÊï∞size
                       219 **Êàª„ÇäÂÄ§
                       220 **d0:ÂÆüÈöõ„Å´ÈÄÅ‰ø°„Åó„Åü„Éá„Éº„ÇøÊï∞
                       221 *************************************************************
                       222 PUTSTRING:
000528 48E7 7EFE       223 		movem.l %a0-%a6/%d1-%d6, -(%SP)
                       224 
00052c 0C81 0000       225 		cmp.l #0x00, %d1		/*ch!=0„ÅßÂàÜÂ≤ê*/
       0000            225 
000532 6600 0044       226 		bne PUTSTRING_END
                       227 		/* rv: „Éê„Ç§„Éà„Çµ„Ç§„Ç∫„ÅÆÊØîËºÉ„ÄÇÔºê„Åß„ÅØ„Å™„ÅÑ„Å®„Åç„Å´ÁµÇ‰∫Ü„Åô„Çã*/
                       228 
000536 7800            229 		move.l #0x0000,%d4 		/*%d4=sz:ÈÄÅ‰ø°„Åó„Åü„Éá„Éº„ÇøÊï∞„ÇíÊ†ºÁ¥ç*/
                       230 		/* rv: „Éá„Éº„ÇøÊï∞(sz)„ÅÆÂàùÊúüÂåñ*/
                       231 
000538 2242            232 		move.l %d2,%a1 		/*%d5:„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„ÅøÂÖà„Ç¢„Éâ„É¨„Çπ/
                       233 		/* rv: Ë™≠„ÅøËæº„ÅøÂÖà„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ„Çía1„Å´Ê†ºÁ¥ç„Åô„Çã*/	
                       234 
00053a 0C83 0000       235 		cmp.l #0x0000,%d3		/*size=0„ÅßÂàÜÂ≤ê*/
       0000            235 
000540 6700 0036       236 		beq PUTSTRING_END
                       237 		/* rv: d3(size)„Åå0„Å™„Çâ„Å∞ÁµÇ‰∫Ü„Åô„Çã*/
                       238 
                       239 
                       240 LOOP_STEP5:
000544 B684            241 		cmp.l %d4,%d3		/*sz=size„ÅßÂàÜÂ≤ê*/
000546 6700 001C       242 		beq PUTSTRING_MASK
                       243 		/* d3 „Å® d4 size = sz „Å™„Çâ„Å∞„Éû„Çπ„ÇØ„Å∏ÁßªÂãï*/
                       244 
00054a 7001            245 		move.l #0x01,%d0 		/*„Ç≠„É•„ÉºÁï™Âè∑„ÅÆË®≠ÂÆö*/
00054c 1219            246 		move.b (%a1)+,%d1	/*„Éá„Éº„Çø„ÇíINQ„ÅÆÂÖ•Âäõd1„Å´Ê†ºÁ¥ç*/
                       247 		/* rv: ÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ„Åã„ÇâÈ†Ü„Å´Ê†ºÁ¥ç„Åô„Çã*/
                       248 
00054e 4EB9 0000       249 		jsr INQ
       0000            249 
                       250 
000554 0C80 0000       251 		cmp.l #0x00,%d0		/*ÊàêÂäüorÂ§±ÊïóÂà§ÂÆö*/
       0000            251 
                       252 
00055a 6700 0008       253 		beq PUTSTRING_MASK
                       254 		/*rv : Â§±Êïó„Å™„Çâ„Å∞„Éû„Çπ„ÇØ„Å∏ÁßªÂãï„Åô„Çã*/
                       255 
00055e 5284            256 		addq.l #0x01,%d4		/*sz++*/
000560 6000 FFE2       257 		bra LOOP_STEP5
                       258 
                       259 PUTSTRING_MASK:
                       260 
000564 33FC E10C       261 		move.w #0xe10c, USTCNT1	/*ÈÄÅ‰ø°Ââ≤„ÇäËæº„ÅøË®±ÂèØ*/
       00FF F900       261 
00056c 13FC 0039       262 		move.b #'9', LED0
       00D0 0039       262 
                       263 
                       264 
000574 6000 0002       265 		bra PUTSTRING_END
                       266 
                       267 PUTSTRING_END:
                       268 
000578 2004            269 		move.l %d4,%d0		/*Êàª„ÇäÂÄ§d0„Å´ÂÆüÈöõ„Å´ÈÄÅ‰ø°„Åó„Åü„Éá„Éº„ÇøÊï∞„ÇíÊ†ºÁ¥ç*/
00057a 4CDF 7F7E       270 		movem.l (%SP)+, %a0-%a6/%d1-%d6
                       271 		/* bus errorÂá∫„Åü„ÅÆ„ÅßÂ§âÊõ¥„Åó„Åü*/
                       272 
                       273 		***
00057e 13FC 0034       274 		move.b #'4', LED4
       00D0 0029       274 
                       275 		***
000586 4E75            276 		rts
                       277 
                       278 /* „Ç≠„É•„ÉºÈ†òÂüü„ÅÆÂâçÂæå„Åß„ÅÆÊõ∏„ÅçËæº„Åø„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã„Åì„Å®*/
                       279 *******************************************************
                       280 ** 		QUEUE (TA)
                       281 *******************************************************
                       282 
                       283 
                       284 .section .data
                       285 .equ TOP, 0
                       286 .equ BOTTOM, 4
                       287 .equ IN, 8
                       288 .equ OUT, 12
                       289 .equ S, 16
                       290 .equ DATA_TOP, 18
                       291 .equ DATA_LEN, 256
                       292 .equ QUEUE_SIZE, DATA_TOP + DATA_LEN /* 18 + 256 = 274 */
                       293 
0005a8 0000 0000       294 QUEUE_TOP: ds.b QUEUE_SIZE * 2
       0000 0000       294 
       0000 0000       294 
       0000 0000       294 
       0000 0000       294 
                       295 
                       296 /* ÂàùÊúüÂåñ */
                       297 ********************
                       298 * ÂàùÊúüÂåñ
                       299 ********************
                       300 
                       301 Init_Q:
0007cc 48E7 C0E0       302     movem.l %d0-%d1/%a0-%a2, -(%sp) /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÈÄÄÈÅø */
                       303 
0007d0 7000            304     move.l #0, %d0 /* „Ç≠„É•„ÉºÁï™Âè∑ = 0 */
                       305 
                       306 Init_Q_sub:
0007d2 41FA FDD4       307     lea.l QUEUE_TOP, %a0 /* „Ç≠„É•„Éº„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
0007d6 2200            308     move.l %d0, %d1
0007d8 C2FC 0112       309     mulu.w #QUEUE_SIZE, %d1 /* „Ç≠„É•„Éºn„ÅÆÁõ∏ÂØæÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = n * („Ç≠„É•„Éº„Çµ„Ç§„Ç∫) */
0007dc D1C1            310     add.l %d1, %a0 /* a0 = „Ç≠„É•„Éºn„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
0007de 43E8 0012       311     lea.l DATA_TOP(%a0), %a1 /* a1 = „Ç≠„É•„Éºn„ÅÆ„Éá„Éº„ÇøÈ†òÂüüÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = DATA_TOP + a0
0007e2 2089            312     move.l %a1, TOP(%a0) /* „Ç≠„É•„Éºn„ÅÆTOP„ÅÆ„Ç¢„Éâ„É¨„Çπ = a0 + TOP „Åß„ÅÇ„Çã„ÅÆ„Åß„Åù„Åì„Å´a1„Ç
0007e4 2149 0008       313     move.l %a1, IN(%a0) /* „Ç≠„É•„Éºn„ÅÆIN„ÅÆ„Ç¢„Éâ„É¨„Çπ„Å´a1„ÇíÊ†ºÁ¥ç */
0007e8 2149 000C       314     move.l %a1, OUT(%a0) /* „Ç≠„É•„Éºn„ÅÆOUT„ÅÆ„Ç¢„Éâ„É¨„Çπ„Å´a1„ÇíÊ†ºÁ¥ç */
                       315 
                       316 	/*lea -> movea*/
                       317     *move.l BOTTOM(%a0), %a1 /* a1 = „Ç≠„É•„Éºn„ÅÆBOTTOM„ÅÆ„Ç¢„Éâ„É¨„Çπ */
0007ec 43E8 0111       318     lea.l QUEUE_SIZE-1(%a0), %a1 /* a1 == BOTTOM = „Ç≠„É•„Éºn„ÅÆÁµÇÁ´Ø„Ç¢„Éâ„É¨„Çπ */
0007f0 2149 0004       319     move.l %a1, BOTTOM(%a0)
                       320 
0007f4 317C 0000       321     move.w #0, S(%a0) /* „Éá„Éº„ÇøÊï∞ = 0 */
       0010            321 
0007fa 5280            322     addq.l #1, %d0 /* „Ç≠„É•„ÉºÁï™Âè∑++ */
0007fc 0C80 0000       323     cmpi.l #2, %d0 /* „Ç≠„É•„Éº„ÅÆÂÄãÊï∞ÂàÜ(2)„É´„Éº„Éó */
       0002            323 
000802 6600 FFCE       324     bne Init_Q_sub
                       325 
000806 4CDF 0703       326     movem.l (%sp)+, %d0-%d1/%a0-%a2 /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞ */
00080a 4E75            327     rts
                       328 
                       329 
                       330 *****************
                       331 ** INQ
                       332 *****************
                       333 
                       334 **************************************
                       335 **ÂÖ•Âäõ
                       336 **  d0:„Ç≠„É•„Éº„ÅÆÈÅ∏Êäû [long]
                       337 **  d1:Êõ∏„ÅçËæº„ÇÄ„Éá„Éº„Çø [long]
                       338 **Âá∫Âäõ
                       339 **  d0:ÊàêÂäü(1)orÂ§±Êïó(0) [long]
                       340 **************************************
                       341 INQ:
                       342 
                       343     /* ÁèæËµ∞Ë°å„É¨„Éô„É´„ÅÆÈÄÄÈÅø */
00080c 40E7            344     move.w %SR, -(%sp)
                       345 
                       346     /* Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢ */
00080e 46FC 2700       347     move.w #0x2700, %SR
                       348 
000812 48E7 00C0       349     movem.l %a0-%a1, -(%sp)
000816 41FA FD90       350     lea.l QUEUE_TOP, %a0 /* a0 = „Ç≠„É•„Éº0„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
00081a C0FC 0112       351     mulu.w #QUEUE_SIZE, %d0 /* „Ç≠„É•„Éºn„ÅÆÁõ∏ÂØæÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = n * („Ç≠„É•„Éº„Çµ„Ç§„Ç∫) */
00081e D1C0            352     add.l %d0, %a0 /* a0 = „Ç≠„É•„Éºn„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
                       353 
000820 0C68 0100       354     cmpi.w #256, S(%a0)
       0010            354 
000826 6600 0008       355     bne INQ_1
                       356 
                       357     /* S == 256„ÅÆ„Å®„Åçd0 = 0(Â§±Êïó) „Å®„Åó„Å¶END„Å∏ */
00082a 7000            358     move.l #0, %d0
00082c 6000 0024       359     bra INQ_END
                       360 
                       361 INQ_1:
000830 2268 0008       362     movea.l IN(%a0), %a1 /* a1 = in */
000834 1281            363     move.b %d1, (%a1) /* q[in] = d1 */ 
                       364 
000836 B3E8 0004       365     cmpa.l BOTTOM(%a0), %a1 /* in == bottom „Åã„ÇíÂà§ÂÆö */
00083a 6600 000A       366     bne INQ_ELSE
                       367 
                       368     /* in == bottom „ÅÆ„Å®„Åç*/
00083e 2150 0008       369     move.l TOP(%a0), IN(%a0) /* in = top */
000842 6000 0008       370     bra INQ_2
                       371 
                       372 /* in != bottom „ÅÆ„Å®„Åç*/
                       373 INQ_ELSE:
000846 5289            374     addq.l #1, %a1 /* a1++ */
000848 2149 0008       375     move.l %a1, IN(%a0) /* in = a1 */
                       376 
                       377 /* s++, d0 = 1(ÊàêÂäü) „Å®„Åó„Å¶END„Å∏ */
                       378 INQ_2:
00084c 5268 0010       379     addq.w #1, S(%a0)
000850 7001            380     move.l #1, %d0
                       381 
                       382 /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞ */
                       383 INQ_END:
000852 4CDF 0300       384     movem.l (%sp)+, %a0-%a1 
000856 46DF            385     move.w (%sp)+, %SR
000858 4E75            386     rts
                       387 
                       388 
                       389 *****************
                       390 * OUTQ
                       391 *****************
                       392 
                       393 **********************************************
                       394 **ÂÖ•Âäõ
                       395 **  d0:„Ç≠„É•„Éº„ÅÆÈÅ∏Êäû  [long]
                       396 
                       397 **Âá∫Âäõ
                       398 **  d0:ÊàêÂäü(1)orÂ§±Êïó(0) [long]
                       399 **  d1:Âèñ„ÇäÁµÑ„Çì„Å†„Éá„Éº„Çø [byte]
                       400 **********************************************
                       401 OUTQ:
                       402     /* ÁèæËµ∞Ë°å„É¨„Éô„É´„ÅÆÈÄÄÈÅø */
00085a 40E7            403     move.w %SR, -(%sp)
                       404 
                       405     /* Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢ */
00085c 46FC 2700       406     move.w #0x2700, %SR
                       407 
000860 48E7 00C0       408     movem.l %a0-%a1, -(%sp)
000864 41FA FD42       409     lea.l QUEUE_TOP, %a0 /* a0 = „Ç≠„É•„Éº0„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
000868 C0FC 0112       410     mulu.w #QUEUE_SIZE, %d0 /* „Ç≠„É•„Éºn„ÅÆÁõ∏ÂØæÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = n * („Ç≠„É•„Éº„Çµ„Ç§„Ç∫) */
00086c D1C0            411     add.l %d0, %a0 /* a0 = „Ç≠„É•„Éºn„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
                       412 
00086e 0C68 0000       413     cmpi.w #0, S(%a0)
       0010            413 
000874 6600 0008       414     bne OUTQ_1
                       415 
                       416     /* S == 0„ÅÆ„Å®„Åçd0 = 0(Â§±Êïó) „Å®„Åó„Å¶END„Å∏ */
000878 7000            417     move.l #0, %d0
00087a 6000 0024       418     bra OUTQ_END
                       419 
                       420 OUTQ_1:
00087e 2268 000C       421     movea.l OUT(%a0), %a1 /* a1 = out */
000882 1211            422     move.b (%a1), %d1 /* d1 = q[out] */
                       423 
000884 B3E8 0004       424     cmpa.l BOTTOM(%a0), %a1 /* out == bottom „Åã„ÇíÂà§ÂÆö */
000888 6600 000A       425     bne OUTQ_ELSE
                       426 
                       427     /* out == bottom „ÅÆ„Å®„Åç*/
00088c 2150 000C       428     move.l TOP(%a0), OUT(%a0) /* out = top */
000890 6000 0008       429     bra OUTQ_2
                       430 
                       431 /* out != bottom „ÅÆ„Å®„Åç*/
                       432 OUTQ_ELSE:
000894 5289            433     addq.l #1, %a1 /* a1++ */
000896 2149 000C       434     move.l %a1, OUT(%a0) /* out = a1 */
                       435 
                       436 /* s--, d0 = 1(ÊàêÂäü) „Å®„Åó„Å¶END„Å∏ */
                       437 OUTQ_2:
00089a 5368 0010       438     subq.w #1, S(%a0)
00089e 7001            439     move.l #1, %d0
                       440 
                       441 /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞ */
                       442 OUTQ_END:
0008a0 4CDF 0300       443     movem.l (%sp)+, %a0-%a1 
0008a4 46DF            444     move.w (%sp)+, %SR
0008a6 13FC 0038       445     move.b #'8', LED1
       00D0 003B       445 
0008ae 4E75            446     rts
