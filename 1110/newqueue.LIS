                         4 .list
                         5 .section .data
                         6 ******************************
                         7 ** キュー用のメモリ領域確保 ↓↓
                         8 ******************************
                         9 .equ B_SIZE, 256
                        10 .equ ALL_B_SIZE, B_SIZE + B_SIZE |受信と送信で１本ずつ|
                        11 
000000 0000 0000        12 top: .ds.b ALL_B_SIZE-1 |キューのデータ領域|
       0000 0000        12 
       0000 0000        12 
       0000 0000        12 
       0000 0000        12 
0001ff 00               13 bottom: .ds.b 1
000200 0000 0000        14 in: .ds.l 2 |キューの各種ポインタ↓|
       0000 0000        14 
000208 0000 0000        15 out: .ds.l 2
       0000 0000        15 
000210 0000             16 PUT_FLG: .ds.b 2
000212 0000             17 GET_FLG: .ds.b 2
000214 0000 0000        18 s: .ds.l 2
       0000 0000        18 
                        19 
00021c 0000 0000        20 top_ptr: .ds.l 1 |実行時用一時保存領域↓|
000220 0000 0000        21 bottom_ptr: .ds.l 1
000224 0000 0000        22 in_ptr: .ds.l 1
000228 0000 0000        23 out_ptr: .ds.l 1
00022c 00               24 PUT_FLG_ptr: .ds.b 1
00022d 00               25 GET_FLG_ptr: .ds.b 1
00022e 0000 0000        26 s_ptr: .ds.l 1
                        27 
                        28 .even
                        29 ******************************
                        30 ** キュー用のメモリ領域確保 ↑↑
                        31 ******************************
                        32 
                        33 **********************  
                        34 
                        35 ** キューの初期化処理↓↓  
                        36 
                        37 **********************  
                        38 
                        39 Init_Q: 
                        40 
000232 48E7 80F8        41  	movem.l	%d0/%a0-%a4, -(%sp) 
                        42 
                        43   
                        44 
000236 7002             45 	move.l	#2, %d0			/*#4 -> #2*/ 
                        46 
                        47   
                        48 
000238 41FA FDC6        49 	lea.l 	top, %a0 
                        50 
00023c 43FA FFC2        51  	lea.l	in, %a1 
                        52 
000240 45FA FFC6        53  	lea.l	out, %a2 
                        54 
000244 47FA FFCA        55  	lea.l	PUT_FLG, %a3 
                        56 
000248 49FA FFC8        57  	lea.l	GET_FLG, %a4 
                        58 
                        59   
                        60 
                        61 Loop_Init:	 
                        62 
00024c 22C8             63  	move.l 	%a0, (%a1)+ 
                        64 
00024e 24C8             65  	move.l 	%a0, (%a2)+ 
                        66 
000250 16FC 0001        67  	move.b 	#0x01, (%a3)+ 
                        68 
000254 18FC 0000        69  	move.b 	#0x00, (%a4)+ 
                        70 
                        71   
                        72 
000258 D1FC 0000        73 	adda.l	#B_SIZE, %a0 
       0100             73 
                        74 
                        75   
                        76 
00025e 5380             77 	subq.l	#1, %d0 
                        78 
000260 6200 FFEA        79  	bhi	Loop_Init 
                        80 
                        81   
                        82 
000264 4CDF 1F01        83 	movem.l	(%sp)+, %d0/%a0-%a4 
                        84 
000268 4E75             85  	rts 
                        86 
                        87  **********************  
                        88 
                        89 ** キューの初期化処理 ↑↑ 
                        90 
                        91  **********************  
                        92 
                        93  
                        94 
                        95  
                        96 
                        97 ***********************************  
                        98 
                        99 ** INQ キューへのデータ書き込み↓↓ 
                       100 
                       101  ** a0: 書き込むデータのアドレス  
                       102 
                       103 ** (入力)d0: 書き込むキューの番号0~1		 
                       104 
                       105  ** (出力)d0: 結果(00:失敗, 01:成功)  
                       106 
                       107 *********************************** 
                       108 
                       109  INQ: 
                       110 
00026a 48E7 7EFE       111  	movem.l	%d1-%d6/%a0-%a6, -(%sp)		/*現走行レベルの退避*/ 
                       112 
00026e 40E7            113  	move.w	%SR, -(%sp) 
                       114 
000270 46FC 2700       115  	move.w	#0x2700, %SR			/*割り込み禁止*/ 
                       116 
                       117  		 
                       118 
000274 2600            119 	move.l	%d0, %d3		/*キュー番号の保存*/ 
                       120 
                       121   
                       122 
000276 49FA FF98       123 	lea.l	PUT_FLG, %a4 
                       124 
00027a D9C0            125  	add.l	%d0, %a4 
                       126 
00027c 13D4 0000       127  	move.b	(%a4), PUT_FLG_ptr 
       0000            127 
                       128 
                       129   
                       130 
000282 49FA FF8E       131 	lea.l	GET_FLG, %a4 
                       132 
000286 D9C0            133  	add.l	%d0, %a4 
                       134 
000288 13D4 0000       135  	move.b	(%a4), GET_FLG_ptr 
       0000            135 
                       136 
                       137   
                       138 
00028e C0FC 0004       139 	mulu	#4, %d0			 
                       140 
000292 49FA FF6C       141  	lea.l	in, %a4 
                       142 
000296 D9C0            143  	add.l	%d0, %a4 
                       144 
000298 23D4 0000       145  	move.l	(%a4), in_ptr 
       0000            145 
                       146 
                       147   
                       148 
00029e 49FA FF68       149 	lea.l	out, %a4 
                       150 
0002a2 D9C0            151  	add.l	%d0, %a4 
                       152 
0002a4 23D4 0000       153  	move.l	(%a4), out_ptr 
       0000            153 
                       154 
                       155   
                       156 
0002aa C0FC 0040       157 	mulu	#64, %d0 
                       158 
0002ae 49FA FD50       159  	lea.l 	top, %a4 
                       160 
0002b2 D9C0            161  	add.l	%d0, %a4 
                       162 
0002b4 23CC 0000       163  	move.l	%a4, top_ptr 
       0000            163 
                       164 
                       165   
                       166 
0002ba 243C 0000       167 	move.l	#256, %d2		/*#768 -> #256*/ 
       0100            167 
                       168 
0002c0 9480            169  	sub.l	%d0, %d2 
                       170 
0002c2 7000            171  	move.l	#0, %d0			/*d0初期化*/	 
                       172 
0002c4 49FA FF39       173  	lea.l	bottom, %a4 
                       174 
0002c8 99C2            175  	sub.l	%d2, %a4 
                       176 
0002ca 23CC 0000       177  	move.l	%a4, bottom_ptr 
       0000            177 
                       178 
                       179   
                       180 
0002d0 4EBA 0036       181 	jsr 	PUT_BUF 	/* キューへの書き込み */ 
                       182 
                       183   
                       184 
0002d4 49FA FF3A       185 	lea.l	PUT_FLG, %a4 
                       186 
0002d8 D9C3            187  	add.l	%d3, %a4	 
                       188 
0002da 18BA FF50       189  	move.b 	PUT_FLG_ptr,(%a4)	 
                       190 
                       191   
                       192 
0002de 49FA FF32       193 	lea.l	GET_FLG, %a4 
                       194 
0002e2 D9C3            195  	add.l	%d3, %a4	 
                       196 
0002e4 18BA FF47       197  	move.b 	GET_FLG_ptr,(%a4)	 
                       198 
                       199   
                       200 
                       201  
                       202 
0002e8 C6FC 0004       203 	mulu	#4, %d3 
                       204 
0002ec 49FA FF12       205  	lea.l 	in, %a4 
                       206 
0002f0 D9C3            207  	add.l	%d3, %a4 
                       208 
0002f2 28BA FF30       209  	move.l	in_ptr, (%a4) 
                       210 
                       211   
                       212 
0002f6 49FA FF10       213 	lea.l	out, %a4 
                       214 
0002fa D9C3            215  	add.l	%d3, %a4 
                       216 
0002fc 28BA FF2A       217  	move.l	out_ptr, (%a4) 
                       218 
                       219   
                       220 
000300 46DF            221 	move.w	(%sp)+, %SR 
                       222 
000302 4CDF 7F7E       223  	movem.l	(%sp)+, %d1-%d6/%a0-%a6		/*旧走行レベルの回復*/ 
                       224 
000306 4E75            225  	rts 
                       226 
                       227  ***********************************  
                       228 
                       229 ** INQ キューへのデータ書き込み↑↑ 
                       230 
                       231  *********************************** 
                       232 
                       233   
                       234 
                       235  
                       236 
                       237 ****************************************  
                       238 
                       239 ** PUT_BUF↓↓ 
                       240 
                       241  ** a0: 書き込むデータのアドレス 
                       242 
                       243  ** d0: 結果(00:失敗, 00以外:成功)  
                       244 
                       245 ** d1: 書き込む8bitデータ 
                       246 
                       247  ****************************************  
                       248 
                       249 PUT_BUF: 
                       250 
000308 48E7 0070       251  	movem.l	%a1-%a3, -(%sp) 
                       252 
00030c 103A FF1E       253  	move.b	PUT_FLG_ptr, %d0 
                       254 
                       255   
                       256 
000310 0C00 0000       257 	cmp.b	#0x00, %d0		/* PUT不可能(失敗) */ 
                       258 
000314 6700 0040       259  	beq	PUT_BUF_Finish 
                       260 
                       261   
                       262 
000318 227A FF0A       263 	movea.l	in_ptr, %a1		/* キューにデータを挿入 */ 
                       264 
00031c 12C1            265  	move.b	%d1, (%a1)+ 
                       266 
                       267   
                       268 
00031e 06B9 0000       269 	addi.l	#1, s			/* キュー内のデータ数:+1 */ 
       0001 0000       269 
       0000            269 
                       270 
                       271   
                       272 
000328 267A FEF6       273 	move.l	bottom_ptr, %a3		/* a3はキュー末尾 */ 
                       274 
00032c B3CB            275  	cmpa.l	%a3, %a1		/* PUTポインタが末尾を超えた */ 
                       276 
00032e 6300 0008       277  	bls	PUT_BUF_STEP1	 
                       278 
                       279   
                       280 
000332 247A FEE8       281 	move.l	top_ptr, %a2	/* PUTポインタを先頭に戻す */ 
                       282 
000336 224A            283  	movea.l	%a2, %a1 
                       284 
                       285   
                       286 
                       287 PUT_BUF_STEP1: 
                       288 
000338 23C9 0000       289  	move.l	%a1, in_ptr 
       0000            289 
                       290 
                       291   
                       292 
00033e B3FA FEE8       293 	cmpa.l	out_ptr, %a1	/* PUTポインタがGETポインタに追いついた */ 
                       294 
000342 6600 000A       295  	bne	PUT_BUF_STEP2 
                       296 
                       297   
                       298 
000346 13FC 0000       299 	move.b	#0x00, PUT_FLG_ptr	/* 満タンなのでPUT不可能(フラグ) */ 
       0000 0000       299 
                       300 
                       301   
                       302 
                       303 PUT_BUF_STEP2: 
                       304 
00034e 13FC 0001       305  	move.b	#0x01, GET_FLG_ptr 
       0000 0000       305 
                       306 
                       307   
                       308 
                       309 PUT_BUF_Finish: 
                       310 
000356 4CDF 0E00       311  	movem.l	(%sp)+, %a1-%a3 
                       312 
00035a 4E75            313  	rts 
                       314 
                       315  ****************************************  
                       316 
                       317 ** PUT_BUF↑↑ 
                       318 
                       319  **************************************** 
                       320 
                       321  
                       322 
                       323  
                       324 
                       325 ***********************************  
                       326 
                       327 ** OUTQ キューからの読み出し↓↓ 
                       328 
                       329  ** a2: 読み出し先アドレス 
                       330 
                       331  ** d0(入力):キュー番号 
                       332 
                       333  ** d0(出力): 結果(00:失敗, 01:成功)  
                       334 
                       335 ** d1: 取り出した8bitデータ 
                       336 
                       337  *********************************** 
                       338 
                       339  OUTQ: 
                       340 
00035c 48E7 3EFE       341  	movem.l	%d2-%d6/%a0-%a6, -(%sp) 
                       342 
000360 40E7            343  	move.w	%SR, -(%sp)		/*現走行レベルの退避*/ 
                       344 
000362 46FC 2700       345  	move.w	#0x2700, %SR			/*割り込み禁止*/ 
                       346 
                       347   
                       348 
000366 2600            349 	move.l	%d0, %d3		/*キュー番号の保存*/ 
                       350 
                       351   
                       352 
000368 49FA FEA6       353 	lea.l	PUT_FLG, %a4 
                       354 
00036c D9C0            355  	add.l	%d0, %a4 
                       356 
00036e 13D4 0000       357  	move.b	(%a4), PUT_FLG_ptr 
       0000            357 
                       358 
                       359   
                       360 
000374 49FA FE9C       361 	lea.l	GET_FLG, %a4 
                       362 
000378 D9C0            363  	add.l	%d0, %a4 
                       364 
00037a 13D4 0000       365  	move.b	(%a4), GET_FLG_ptr 
       0000            365 
                       366 
                       367   
                       368 
000380 C0FC 0004       369 	mulu	#4, %d0			 
                       370 
000384 49FA FE7A       371  	lea.l	in, %a4 
                       372 
000388 D9C0            373  	add.l	%d0, %a4 
                       374 
00038a 23D4 0000       375  	move.l	(%a4), in_ptr 
       0000            375 
                       376 
                       377   
                       378 
000390 49FA FE76       379 	lea.l	out, %a4 
                       380 
000394 D9C0            381  	add.l	%d0, %a4 
                       382 
000396 23D4 0000       383  	move.l	(%a4), out_ptr 
       0000            383 
                       384 
                       385   
                       386 
00039c C0FC 0040       387 	mulu	#64, %d0 
                       388 
0003a0 49FA FC5E       389  	lea.l 	top, %a4 
                       390 
0003a4 D9C0            391  	add.l	%d0, %a4 
                       392 
0003a6 23CC 0000       393  	move.l	%a4, top_ptr 
       0000            393 
                       394 
                       395   
                       396 
0003ac 243C 0000       397 	move.l	#256, %d2		/*#768 -> #256*/ 
       0100            397 
                       398 
0003b2 9480            399  	sub.l	%d0, %d2 
                       400 
0003b4 7000            401  	move.l	#0, %d0			/*d0初期化*/	 
                       402 
0003b6 49FA FE47       403  	lea.l	bottom, %a4 
                       404 
0003ba 99C2            405  	sub.l	%d2, %a4 
                       406 
0003bc 23CC 0000       407  	move.l	%a4, bottom_ptr 
       0000            407 
                       408 
                       409   
                       410 
0003c2 4EBA 0036       411 	jsr 	GET_BUF 	/* キューからの読み出し */ 
                       412 
                       413   
                       414 
0003c6 49FA FE48       415 	lea.l	PUT_FLG, %a4 
                       416 
0003ca D9C3            417  	add.l	%d3, %a4	 
                       418 
0003cc 18BA FE5E       419  	move.b 	PUT_FLG_ptr,(%a4)	 
                       420 
                       421   
                       422 
0003d0 49FA FE40       423 	lea.l	GET_FLG, %a4 
                       424 
0003d4 D9C3            425  	add.l	%d3, %a4	 
                       426 
0003d6 18BA FE55       427  	move.b 	GET_FLG_ptr,(%a4)	 
                       428 
                       429   
                       430 
                       431  
                       432 
0003da C6FC 0004       433 	mulu	#4, %d3 
                       434 
0003de 49FA FE20       435  	lea.l 	in, %a4 
                       436 
0003e2 D9C3            437  	add.l	%d3, %a4 
                       438 
0003e4 28BA FE3E       439  	move.l	in_ptr, (%a4) 
                       440 
                       441   
                       442 
0003e8 49FA FE1E       443 	lea.l	out, %a4 
                       444 
0003ec D9C3            445  	add.l	%d3, %a4 
                       446 
0003ee 28BA FE38       447  	move.l	out_ptr, (%a4) 
                       448 
                       449   
                       450 
                       451  
                       452 
0003f2 46DF            453 	move.w	(%sp)+, %SR		/*旧走行状態の回復*/ 
                       454 
0003f4 4CDF 7F7C       455  	movem.l	(%sp)+, %d2-%d6/%a0-%a6 
                       456 
0003f8 4E75            457  	rts 
                       458 
                       459  ***********************************  
                       460 
                       461 ** OUTQ キューからの読み出し↑↑ 
                       462 
                       463  *********************************** 
                       464 
                       465   
                       466 
                       467  
                       468 
                       469 ****************************************  
                       470 
                       471 ** GET_BUF↓↓ 
                       472 
                       473  ** a2: 読み出し先アドレス 
                       474 
                       475  ** d0: 結果(00:失敗, 00以外:成功)  
                       476 
                       477 ** d1: 取り出した8bitデータ 
                       478 
                       479  ****************************************  
                       480 
                       481 GET_BUF: 
                       482 
0003fa 48E7 0058       483  	movem.l	%a1/%a3-%a4, -(%sp) 
                       484 
0003fe 103A FE2D       485  	move.b	GET_FLG_ptr, %d0 
                       486 
                       487   
                       488 
000402 0C00 0000       489 	cmp.b	#0x00, %d0	/* GET不可能(失敗) */ 
                       490 
000406 6700 0040       491  	beq	GET_BUF_Finish 
                       492 
                       493   
                       494 
00040a 227A FE1C       495 	movea.l	out_ptr, %a1	/* キューからデータを読み出す */ 
                       496 
00040e 1219            497  	move.b	(%a1)+, %d1	/* 取り出したデータ */ 
                       498 
                       499   
                       500 
                       501  
                       502 
000410 04B9 0000       503 	subi.l	#1, s		/* キュー内のデータ数:-1 */ 
       0001 0000       503 
       0000            503 
                       504 
                       505   
                       506 
00041a 267A FE04       507 	move.l	bottom_ptr, %a3	/* a3はキュー末尾 */ 
                       508 
00041e B3CB            509  	cmpa.l	%a3, %a1	/* GETポインタが末尾を超えた */ 
                       510 
000420 6300 0008       511  	bls	GET_BUF_STEP1	 
                       512 
                       513   
                       514 
000424 287A FDF6       515 	move.l	top_ptr, %a4	/* GETポインタを先頭に戻す */ 
                       516 
000428 224C            517  	movea.l	%a4, %a1 
                       518 
                       519   
                       520 
                       521 GET_BUF_STEP1: 
                       522 
00042a 23C9 0000       523  	move.l	%a1, out_ptr 
       0000            523 
                       524 
                       525   
                       526 
000430 B3FA FDF2       527 	cmpa.l	in_ptr, %a1	/* GETポインタがPUTポインタに追いついた */ 
                       528 
000434 6600 000A       529  	bne	GET_BUF_STEP2 
                       530 
                       531   
                       532 
000438 13FC 0000       533 	move.b	#0x00, GET_FLG_ptr	/* データがないのでGET不可能(フラグ) */ 
       0000 0000       533 
                       534 
                       535   
                       536 
                       537 GET_BUF_STEP2: 
                       538 
000440 13FC 0001       539  	move.b	#0x01, PUT_FLG_ptr 
       0000 0000       539 
                       540 
                       541   
                       542 
                       543 GET_BUF_Finish: 
                       544 
000448 4CDF 1A00       545  	movem.l	(%sp)+, %a1/%a3-%a4 
                       546 
00044c 4E75            547  	rts 
                       548 
                       549  ****************************************  
                       550 
                       551 ** GET_BUF↑↑ 
                       552 
                       553  **************************************** 
                       554 
