                         4 .list
                         5 
                         6 
                         7 		***************************************************************
                         8 		**各種レジスタ定義
                         9 		***************************************************************
                        10 
                        11 		***************
                        12 		** レジスタ群の先頭
                        13 		***************
                        14 		.equ REGBASE,   0xFFF000          | DMAPを使用．
                        15 		.equ IOBASE,    0x00d00000
                        16 
                        17 		***************
                        18 		** 割り込み関係のレジスタ
                        19 		***************
                        20 		.equ IVR,       REGBASE+0x300     |割り込みベクタレジスタ
                        21 		.equ IMR,       REGBASE+0x304     |割り込みマスクレジスタ
                        22 		.equ ISR,       REGBASE+0x30c     |割り込みステータスレジスタ
                        23 		.equ IPR,       REGBASE+0x310     |割り込みペンディングレジスタ
                        24 
                        25 		***************
                        26 		** タイマ関係のレジスタ
                        27 		***************
                        28 		.equ TCTL1,     REGBASE+0x600     |タイマ１コントロールレジスタ
                        29 		.equ TPRER1,    REGBASE+0x602     |タイマ１プリスケーラレジスタ
                        30 		.equ TCMP1,     REGBASE+0x604     |タイマ１コンペアレジスタ
                        31 		.equ TCN1,      REGBASE+0x608     |タイマ１カウンタレジスタ
                        32 		.equ TSTAT1,    REGBASE+0x60a     |タイマ１ステータスレジスタ
                        33 
                        34 		***************
                        35 		** UART1（送受信）関係のレジスタ
                        36 		***************
                        37 		.equ USTCNT1,   REGBASE+0x900     | UART1ステータス/コントロールレジスタ
                        38 		.equ UBAUD1,    REGBASE+0x902     | UART1ボーコントロールレジスタ
                        39 		.equ URX1,      REGBASE+0x904     | UART1受信レジスタ
                        40 		.equ UTX1,      REGBASE+0x906     | UART1送信レジスタ
                        41 
                        42 		***************
                        43 		** LED
                        44 		***************
                        45 		.equ LED7,      IOBASE+0x000002f  |ボード搭載のLED用レジスタ
                        46 		.equ LED6,      IOBASE+0x000002d  |使用法については付録A.4.3.1
                        47 		.equ LED5,      IOBASE+0x000002b
                        48 		.equ LED4,      IOBASE+0x0000029
                        49 		.equ LED3,      IOBASE+0x000003f
                        50 		.equ LED2,      IOBASE+0x000003d
                        51 		.equ LED1,      IOBASE+0x000003b
                        52 		.equ LED0,      IOBASE+0x0000039
                        53 
                        54 		***************************************************************
                        55 		** スタック領域の確保
                        56 		***************************************************************
                        57 		.section .bss
                        58 		.even
                        59 SYS_STK:
000a10 0000 0000        60 		.ds.b   0x4000  |システムスタック領域
       0000 0000        60 
       0000 0000        60 
       0000 0000        60 
       0000 0000        60 
                        61 		.even
                        62 SYS_STK_TOP:            |システムスタック領域の最後尾
                        63 
                        64 		***************************************************************
                        65 		**step6テスト用
004a10 0000 0000        66 		WORK: .ds.b 256
       0000 0000        66 
       0000 0000        66 
       0000 0000        66 
       0000 0000        66 
                        67 		***************************************************************
                        68 
                        69 
                        70 		***************************************************************
                        71 		** 初期化
                        72 		** 内部デバイスレジスタには特定の値が設定されている．
                        73 		** その理由を知るには，付録Bにある各レジスタの仕様を参照すること．
                        74 		***************************************************************
                        75 		.section .text
                        76 		.even
                        77 boot:
                        78 		* スーパーバイザ&各種設定を行っている最中の割込禁止
000400 46FC 2700        79 		move.w #0x2700,%SR
000404 4FF9 0000        80 		lea.l  SYS_STK_TOP, %SP | Set SSP
       0000             80 
                        81 
                        82 		****************
                        83 		**割り込みコントローラの初期化
                        84 		****************
00040a 13FC 0040        85 		move.b #0x40, IVR       |ユーザ割り込みベクタ番号を| 0x40+levelに設定．
       00FF F300        85 
000412 23FC 00FF        86 		move.l #0x00ffffff,IMR  |全割り込みマスク /* STEP2.3 */
       FFFF 00FF        86 
       F304             86 
                        87 
                        88 		****************
                        89 		** 送受信(UART1)関係の初期化(割り込みレベルは4に固定されている)
                        90 		****************
00041c 33FC 0000        91 		move.w #0x0000, USTCNT1 |リセット
       00FF F900        91 
000424 33FC E100        92 		move.w #0xe100, USTCNT1 |送受信可能,パリティなし, 1 stop, 8 bit,|送受割り込み禁
       00FF F900        92 
00042c 33FC 0038        93 		move.w #0x0038, UBAUD1  |baud rate = 230400 bps
       00FF F902        93 
                        94 
                        95 		****************
                        96 		** タイマ関係の初期化(割り込みレベルは6に固定されている)
                        97 		*****************
000434 33FC 0004        98 		move.w #0x0004, TCTL1   | restart,割り込み不可,|システムクロックの1/16を単位と
       00FF F600        98 
                        99 
                       100 		***************************************************************
                       101 		** STEP2の処理
                       102 		***************************************************************
                       103 		*lea.l uart1_interrupt, %a0
                       104 		*move.l %a0, 0x110 /* STEP2.1 level 4, (64+4)*4 割り込み処理ルーチンの開始アドレ
00043c 21FC 0000       105 		move.l #uart1_interrupt, 0x110
       0000 0110       105 
000444 33FC E100       106 		move.w #0xe100, USTCNT1 |送受信割り込みマスク
       00FF F900       106 
00044c 23FC 00FF       107 		move.l #0x00ff3ffb,IMR  |UART1許可
       3FFB 00FF       107 
       F304            107 
000456 46FC 2700       108 		move.w #0x2700, %SR    /* 走行レベル7 */
                       109 
                       110 
                       111 
                       112 
00045a 21FC 0000       113 		move.l #uart1_interrupt, 0x110
       0000 0110       113 
                       114 		
                       115 
000462 6000 0002       116 		bra MAIN
                       117 
                       118 		***************************************************************
                       119 		** 現段階での初期化ルーチンの正常動作を確認するため，最後に’a’を
                       120 		** 送信レジスタUTX1に書き込む．'a'が出力されれば，OK.
                       121 		***************************************************************
                       122 		.section .text
                       123 		.even
                       124 
                       125 
                       126 
                       127 
                       128 	
                       129 MAIN:
                       130 		*move.w #0x0800+'a', UTX1 | 0x0800を足す理由については，|付録参照
                       131 
                       132 
000466 4EB9 0000       133 		jsr Init_Q
       0000            133 
                       134 		*move.w #0x1000, %d0
                       135 		
00046c 33FC E10C       136 		move.w #0xe10c, USTCNT1 |送受信割り込み許可
       00FF F900       136 
000474 23FC 00FF       137 		move.l #0x00ff3ffb,IMR  |UART1許可
       3FFB 00FF       137 
       F304            137 
00047e 46FC 2000       138 		move.w #0x2000, %SR    /* 走行レベル0 */
                       139 
000482 4EBA 0006       140 		jsr TEST
                       141 		
                       142 LOOP:
000486 6000 FFFE       143 		bra LOOP
                       144 
                       145 /*以下テスト*/
                       146 TEST:
00048a 48E7 FFFE       147 		movem.l %a0-%a6/%d0-%d7, -(%SP)
                       148 
00048e 46FC 2000       149 		move.w #0x2000, %SR 	/*走行レベルを0に設定*/
                       150 
000492 780F            151 		move.l #0xF,%d4	/*ループ回数*/
                       152 
                       153 LOOP_TEST:/*入力待ち用ループ*/
                       154 
000494 5344            155 		subq #1,%d4
                       156 
000496 0C84 0000       157 		cmp.l #0,%d4
       0000            157 
                       158 
00049c 6700 0006       159 		beq TEST1
                       160 
0004a0 6000 FFF2       161 		bra LOOP_TEST
                       162 
                       163 TEST1:		
                       164 
0004a4 123C 0000       165 		move.b #0,%d1		/*チャネルの設定*/
                       166 
0004a8 41F9 0000       167 		lea.l WORK,%a0		/*データ書き込み先の先頭アドレス*/
       0000            167 
                       168 
0004ae 2408            169 		move.l %a0,%d2		/*データ書き込み先の先頭アドレス*/
                       170 
0004b0 363C 0100       171 		move.w #256,%d3		/*取り出すデータの数*/
                       172 
0004b4 4EBA 00E4       173 		jsr GETSTRING
                       174 
0004b8 123C 0000       175 		move.b #0,%d1		/*チャネルの設定*/
                       176 
0004bc 2408            177 		move.l %a0,%d2		/*データ読み込み先の先頭アドレス*/		
                       178 		
0004be 4EBA 0084       179 		jsr PUTSTRING
                       180 		
0004c2 4CDF 7FFF       181 		movem.l (%SP)+, %a0-%a6/%d0-%d7
                       182 		
0004c6 4E75            183 		rts
                       184 /*以上テスト*/
                       185 
                       186 uart1_interrupt:
0004c8 48E7 8000       187 		movem.l %d0, -(%sp)
                       188 
                       189 		*move.b #'a', %d0 /* URX1の下位8ビットのデータを転送 */
                       190 		*addi.w #0x0800, %d0 /* 即値をレジスタd0に加算 */
                       191 		*move.w %d0, UTX1 /* 16ビットのデータをUTX1に転送 *
                       192 
                       193 		*****************************************************
                       194 		**追加分
0004cc 3639 00FF       195 		move.w URX1,%d3		/*step4:URX1のコピー*/
       F904            195 
0004d2 1403            196 		move.b %d3,%d2		/*下位8bitをコピー*/
0004d4 123C 0000       197 		move.b #0,%d1
0004d8 0C43 2000       198 		cmp #0x2000,%d3
0004dc 6400 00F6       199 		bcc INTERGET
                       200 		*****************************************************
                       201 
                       202 
                       203 
0004e0 3039 00FF       204 		move.w UTX1, %d0	/*step4:UTX1のコピー*/
       F906            204 
                       205 		
0004e6 123C 0000       206 		move.b #0, %d1	/*chの選択*/
                       207 
0004ea 0C40 8000       208 		cmp #0x8000,%d0
0004ee 6400 0008       209 		bcc INTERPUT
                       210 
0004f2 4CDF 0001       211 		movem.l (%sp)+, %d0
0004f6 4E73            212 		rte
                       213 
                       214 
                       215 INTERPUT:
0004f8 48E7 E000       216 	movem.l %d0-%d2, -(%sp)
                       217 
0004fc 46FC 2700       218 	move.w #0x2700, %SR	/*step4.1:走行レベル7*/
                       219 	
000500 0C01 0000       220 	cmp.b #0x0, %d1		/*step4.2:ch!=0で分岐*/
                       221 
000504 6600 0020       222 	bne INTERPUT_END
                       223 
000508 103C 0001       224 	move.b #1, %d0
                       225 	*move.w #0x0800+'a', UTX1
00050c 4EB9 0000       226 	jsr OUTQ		/*step4.3:OUTQの実行*/
       0000            226 
                       227 
000512 0C40 0000       228 	cmp.w #0, %d0		/*step4.4:戻り値が0で分岐*/
000516 6700 0018       229 	beq INTERPUT_MASK
00051a 1401            230 	move.b %d1, %d2
                       231 
00051c 0642 0800       232 	addi.w #0x0800, %d2
                       233 	*move.w #0x0800+'d', UTX1
000520 33C2 00FF       234 	move.w %d2, UTX1	/*step4.5:ヘッダ付与*/
       F906            234 
                       235 
                       236 
                       237 INTERPUT_END:
                       238 	*move.w #0x0800+'c', UTX1
000526 4CDF 0007       239 	movem.l (%sp)+, %d0-%d2
00052a 4CDF 0001       240 	movem.l (%sp)+, %d0
00052e 4E73            241 	rte
                       242 
                       243 INTERPUT_MASK:
000530 33FC 0862       244 	move.w #0x0800+'b', UTX1
       00FF F906       244 
000538 33FC E100       245 	move.w #0xe100, USTCNT1	/*step4.4:送信割り込みのマスク*/
       00FF F900       245 
000540 6000 FFE4       246 	bra INTERPUT_END
                       247 
                       248 
                       249 *************************************************************
                       250 **PUTSTRING
                       251 **入力
                       252 **d1:チャネル
                       253 **d2:データ読み込み先の先頭アドレス
                       254 **d3:送信するデータ数size
                       255 **戻り値
                       256 **d0:実際に送信したデータ数
                       257 *************************************************************
                       258 PUTSTRING:
000544 48E7 7FFE       259 		movem.l %a0-%a6/%d1-%d7, -(%SP)
                       260 
000548 0C01 0000       261 		cmp.b #0x00, %d1		/*ch!=0で分岐*/
00054c 6600 003C       262 		bne PUTSTRING_END
                       263 		/* rv: バイトサイズの比較。０ではないときに終了する*/
                       264 
000550 383C 0000       265 		move.w #0x0000,%d4 		/*%d4=sz:送信したデータ数を格納*/
                       266 		/* rv: データ数(sz)の初期化*/
                       267 
000554 2242            268 		move.l %d2,%a1 		/*%d5:データの読み込み先アドレス/
                       269 		/* rv: 読み込み先の先頭アドレスをa1に格納する*/	
                       270 
000556 0C43 0000       271 		cmp.w #0x0000,%d3		/*size=0で分岐*/
00055a 6700 002E       272 		beq PUTSTRING_END
                       273 		/* rv: d3(size)が0ならば終了する*/
                       274 
                       275 
                       276 LOOP_STEP5:
00055e B644            277 		cmp.w %d4,%d3		/*sz=sizeで分岐*/
000560 6700 001C       278 		beq PUTSTRING_MASK
                       279 		/* d3 と d4 size = sz ならばマスクへ移動*/
                       280 
000564 103C 0001       281 		move.b #0x01,%d0 		/*キュー番号の設定*/
000568 1219            282 		move.b (%a1)+,%d1	/*データをINQの入力d1に格納*/
                       283 		/* rv: 先頭アドレスから順に格納する*/
                       284 
00056a 4EB9 0000       285 		jsr INQ
       0000            285 
                       286 
000570 0C00 0000       287 		cmp.b #0x00,%d0		/*成功or失敗判定*/
000574 6700 0008       288 		beq PUTSTRING_MASK
                       289 		/*rv : 失敗ならばマスクへ移動する*/
                       290 
000578 5244            291 		addq.w #0x01,%d4		/*sz++*/
00057a 6000 FFE2       292 		bra LOOP_STEP5
                       293 
                       294 PUTSTRING_MASK:
                       295 
00057e 33FC E10C       296 		move.w #0xe10c, USTCNT1	/*送信割り込み許可*/
       00FF F900       296 
000586 6000 0002       297 		bra PUTSTRING_END
                       298 
                       299 PUTSTRING_END:
00058a 3004            300 		move.w %d4,%d0		/*戻り値d0に実際に送信したデータ数を格納*/
00058c 4CDF 7FFE       301 		movem.l (%SP)+, %a0-%a6/%d1-%d7
                       302 
                       303 		*rte 			/*?*/
                       304 		/* bus error出たので変更した*/
                       305 
                       306 		***
000590 13FC 0034       307 		move.b #'4', LED4
       00D0 0029       307 
                       308 		***
000598 4E75            309 		rts
                       310 
                       311 ******************************************************************************:
                       312 
                       313 *************************************************************
                       314 **GETSTRING
                       315 **入力
                       316 **d1:チャネル
                       317 **d2:データ書き込み先の先頭アドレス
                       318 **d3:取り出すデータの数
                       319 **戻り値
                       320 **d0:実際に取り出したデータの数
                       321 *************************************************************
                       322 GETSTRING:
00059a 48E7 7FFF       323 	movem.l %a0-%a7/%d1-%d7, -(%SP)
                       324 
00059e 0C41 0000       325 	cmp #0, %d1		/*ch!=0で分岐*/
                       326 	
0005a2 6600 0028       327 	bne GETSTRING_END
                       328 
0005a6 383C 0000       329 	move.w #0,%d4 		/*%d4=sz:取り出したデータ数を格納*/
                       330 
0005aa 2242            331 	move.l %d2,%a1 		/*%d5:データの書き込みアドレス*/
                       332 
                       333 LOOP_STEP6:
0005ac B644            334 	cmp %d4,%d3		/*sz=sizeで分岐*/
                       335 
0005ae 6700 001C       336 	beq GETSTRING_END
                       337 	
0005b2 103C 0000       338 	move.b #0,%d0 		/*キュー番号の設定*/
                       339 	
0005b6 4EB9 0000       340 	jsr OUTQ
       0000            340 
                       341 	
0005bc 0C40 0000       342 	cmp #0,%d0		/*成功or失敗判定*/
                       343 
0005c0 6700 000A       344 	beq GETSTRING_END
                       345 
0005c4 12C1            346 	move.b %d1,(%a1)+	/*取り出したデータをコピー*/
                       347 
0005c6 5244            348 	addq #1,%d4		/*sz++*/
                       349 
0005c8 6000 FFE2       350 	bra LOOP_STEP6
                       351 
                       352 GETSTRING_END:
0005cc 3004            353 	move.w %d4,%d0		/*戻り値d0に実際に取り出したデータ数を格納*/
                       354 
0005ce 4CDF FFFE       355 	movem.l (%SP)+, %a0-%a7/%d1-%d7
                       356 
0005d2 4E75            357 	rts
                       358 
                       359 
                       360 *******************************
                       361 **INTERGET
                       362 **d1:チャネル
                       363 **d2:受信データ
                       364 *******************************
                       365 INTERGET:
0005d4 48E7 FFFF       366 	movem.l %a0-%a7/%d0-%d7, -(%SP)
                       367 
0005d8 0C41 0000       368 	cmp #0, %d1		/*ch!=0で分岐*/
                       369 	
0005dc 6600 000E       370 	bne INTERGET_END
                       371 
0005e0 103C 0000       372 	move.b #0, %d0		/*キュー番号を設定*/
                       373 
0005e4 1202            374 	move.b %d2,%d1		/*キューに入れるデータをd1に格納*/
                       375 	
0005e6 4EB9 0000       376 	jsr INQ
       0000            376 
                       377 
                       378 INTERGET_END:
0005ec 4CDF FFFF       379 	movem.l (%SP)+, %a0-%a7/%d0-%d7
                       380 	
0005f0 4E73            381 	rte
                       382 	**rts /*デバッグ用*/
                       383 
                       384 ******
                       385 ******以降QUEUE
                       386 ******
                       387 
                       388 .section .data
                       389 .equ IN_COUNT, 257
                       390 .equ OUT_COUNT, 257
                       391 .equ queue_number, 1
                       392 .equ OFFSET_1, 0x100
                       393 .equ END_0, 0xff
                       394 .equ END_1, 0x1ff
0005f4 0000 0000       395 top: .ds.b 0x200
       0000 0000       395 
       0000 0000       395 
       0000 0000       395 
       0000 0000       395 
0007f4 0000 0000       396 bottom: .ds.l 1
0007f8 0000 0000       397 in: .ds.l 1
0007fc 0000 0000       398 in_0: .ds.l 1
000800 0000 0000       399 in_1: .ds.l 1
000804 0000 0000       400 out: .ds.l 1
000808 0000 0000       401 out_0: .ds.l 1
00080c 0000 0000       402 out_1: .ds.l 1
000810 0000 0000       403 s: .ds.l 1
000814 0000 0000       404 s0: .ds.l 1
000818 0000 0000       405 s1: .ds.l 1
00081c 0000 0000       406 START_LABEL: .ds.l 1
                       407 
                       408 /* 初期化*/
                       409 Init_Q:
000820 48E7 003E       410 movem.l %a2-%a6, -(%sp) /* 応急処置*/
000824 45FA FDCE       411 lea.l top, %a2
000828 23CA 0000       412 move.l %a2, in_0
       0000            412 
00082e 23CA 0000       413 move.l %a2, out_0
       0000            413 
000834 47EA 0100       414 lea.l OFFSET_1(%a2), %a3
000838 23CB 0000       415 move.l %a3, in_1
       0000            415 
00083e 23CB 0000       416 move.l %a3, out_1
       0000            416 
000844 49FA FFCA       417 lea.l s, %a4
000848 4BFA FFCA       418 lea.l s0, %a5
00084c 4DFA FFCA       419 lea.l s1, %a6
000850 28BC 0000       420 move.l #0,(%a4)
       0000            420 
000856 2ABC 0000       421 move.l #0,(%a5)
       0000            421 
00085c 2CBC 0000       422 move.l #0,(%a6)
       0000            422 
000862 4CDF 7C00       423 movem.l (%sp)+, %a2-%a6 /* 応急処置*/
000866 4E75            424 rts
                       425 
                       426 *****************************************************************
                       427 **d0:キューの選択
                       428 **d1:書き込むデータ
                       429 **d1:返り値、成功or失敗
                       430 *****************************************************************
                       431 INQ:
000868 48E7 1000       432 movem.l %d3, -(%sp)
00086c 40C3            433 move.w %SR, %d3
00086e 46FC 2700       434 move.w #0x2700, %SR
000872 4EBA 000E       435 jsr SELECT_QUEUE
000876 4EBA 008C       436 jsr PUT_BUF
00087a 46C3            437 move.w %d3, %SR
00087c 4CDF 0008       438 movem.l (%sp)+, %d3
000880 4E75            439 rts
                       440 
                       441 SELECT_QUEUE:
000882 0C00 0000       442 cmp.b #0, %d0
000886 6700 000C       443 beq SET_0
00088a 0C00 0001       444 cmp.b #1, %d0
00088e 6700 003A       445 beq SET_1
000892 4E75            446 rts
                       447 
                       448 SET_0:
000894 48E7 0030       449 movem.l %a2-%a3, -(%sp)
000898 23FA FF62       450 move.l in_0, in
       0000 0000       450 
0008a0 23FA FF66       451 move.l out_0, out
       0000 0000       451 
                       452 
0008a8 45FA FD4A       453 lea.l top, %a2
0008ac 23CA 0000       454 move.l %a2, START_LABEL
       0000            454 
0008b2 47EA 00FF       455 lea.l END_0(%a2), %a3
0008b6 23CB 0000       456 move.l %a3, bottom
       0000            456 
0008bc 23FA FF56       457 move.l s0,s
       0000 0000       457 
0008c4 4CDF 0C00       458 movem.l (%sp)+, %a2-%a3
0008c8 4E75            459 rts
                       460 
                       461 SET_1:
0008ca 48E7 0030       462 movem.l %a2-%a3, -(%sp)
0008ce 23FA FF30       463 move.l in_1, in
       0000 0000       463 
0008d6 23FA FF34       464 move.l out_1, out
       0000 0000       464 
                       465 
0008de 45FA FD14       466 lea.l top, %a2
0008e2 47EA 0100       467 lea.l OFFSET_1(%a2), %a3
0008e6 23CB 0000       468 move.l %a3, START_LABEL
       0000            468 
0008ec 47EA 01FF       469 lea.l END_1(%a2), %a3
0008f0 23CB 0000       470 move.l %a3, bottom
       0000            470 
0008f6 23FA FF20       471 move.l s1,s
       0000 0000       471 
0008fe 4CDF 0C00       472 movem.l (%sp)+, %a2-%a3
000902 4E75            473 rts
                       474 
                       475 PUT_BUF:
000904 48E7 407E       476 movem.l %a1-%a6/%d1, -(%sp)
                       477 
000908 243A FF06       478 move.l s,%d2
00090c 0C82 0000       479 cmp.l #0x100,%d2
       0100            479 
000912 6700 0038       480 beq PUT_FAIL 
                       481 
000916 49FA FEF8       482 lea.l s,%a4
00091a 5294            483 addq.l #1,(%a4)
00091c 143C 0001       484 move.b #1,%d2 /*成功*/
000920 227A FED6       485 movea.l in, %a1
000924 12C1            486 move.b %d1, (%a1)+  
                       487 
000926 267A FECC       488 move.l bottom, %a3
00092a B3CB            489 cmpa.l %a3, %a1
00092c 6300 0008       490 bls PUT_BUF_STEP1
000930 247A FEEA       491 move.l START_LABEL, %a2
000934 224A            492 movea.l %a2, %a1
                       493 
                       494 PUT_BUF_STEP1:
000936 23C9 0000       495 move.l %a1, in
       0000            495 
00093c B3FA FEC6       496 cmpa.l out, %a1
000940 6600 0002       497 bne PUT_BUF_STEP2
                       498 
                       499 PUT_BUF_STEP2:
000944 4EBA 0014       500 jsr UPDATE
000948 6000 000A       501 bra PUT_BUF_Finish
                       502 
                       503 PUT_FAIL:
00094c 343C 0000       504 move.w #0,%d2 /*失敗*/
000950 4EBA 0008       505 jsr UPDATE
                       506 
                       507 PUT_BUF_Finish:
000954 4CDF 7E02       508 movem.l (%sp)+, %a1-%a6/%d1
000958 4E75            509 rts
                       510 
                       511 UPDATE:
00095a 0C00 0000       512 cmp.b #0, %d0
00095e 6700 000C       513 beq QUEUE_0
000962 0C00 0001       514 cmp.b #1, %d0
000966 6700 001E       515 beq QUEUE_1
00096a 4E75            516 rts
                       517 
                       518 QUEUE_0:
00096c 23C9 0000       519 move.l %a1, in_0
       0000            519 
000972 23FA FE90       520 move.l out, out_0
       0000 0000       520 
00097a 23FA FE94       521 move.l s,s0
       0000 0000       521 
000982 3002            522 move.w %d2,%d0 /*成功or失敗の返り値*/
                       523 
000984 4E75            524 rts
                       525 QUEUE_1:
000986 23C9 0000       526 move.l %a1, in_1
       0000            526 
00098c 23FA FE76       527 move.l out, out_1
       0000 0000       527 
000994 23FA FE7A       528 move.l s,s1
       0000 0000       528 
00099c 3002            529 move.w %d2,%d0 /*成功or失敗の返り値*/
00099e 4E75            530 rts
                       531 
                       532 ********************************************
                       533 **d0:キューの選択
                       534 **d1:戻り値、取り出したデータ
                       535 ********************************************
                       536 OUTQ:
                       537 *move.w #0x0800+'a', UTX1
0009a0 48E7 1000       538 movem.l %d3, -(%sp)
0009a4 40C3            539 move.w %SR, %d3
0009a6 46FC 2700       540 move.w #0x2700, %SR
0009aa 4EBA FED6       541 jsr SELECT_QUEUE
0009ae 4EBA 000A       542 jsr GET_BUF
0009b2 46C3            543 move.w %d3, %SR
0009b4 4CDF 0008       544 movem.l (%sp)+, %d3
0009b8 4E75            545 rts
                       546 
                       547 GET_BUF:
0009ba 48E7 007E       548 movem.l %a1-%a6, -(%sp)
                       549 
0009be 243A FE50       550 move.l s,%d2
0009c2 0C82 0000       551 cmp.l #0x00,%d2
       0000            551 
0009c8 6700 0038       552 beq GET_FAIL
                       553 
0009cc 143C 0001       554 move.b #1,%d2 /*成功*/
0009d0 49FA FE3E       555 lea.l s,%a4
0009d4 5394            556 subq.l #1,(%a4)
0009d6 227A FE2C       557 movea.l out, %a1
0009da 1219            558 move.b (%a1)+, %d1     
0009dc 267A FE16       559 move.l bottom, %a3
0009e0 B3CB            560 cmpa.l %a3, %a1
0009e2 6300 0008       561 bls GET_BUF_STEP1
0009e6 247A FE34       562 move.l START_LABEL, %a2
0009ea 224A            563 movea.l %a2, %a1
                       564 
                       565 GET_BUF_STEP1:
0009ec 23C9 0000       566 move.l %a1, out
       0000            566 
0009f2 B3FA FE04       567 cmpa.l in, %a1
0009f6 6600 0002       568 bne GET_BUF_STEP2
                       569 
                       570 GET_BUF_STEP2:
0009fa 4EBA FF5E       571 jsr UPDATE
0009fe 6000 000A       572 bra GET_BUF_Finish
                       573 
                       574 GET_FAIL:
000a02 343C 0000       575 move.w #0,%d2 /*失敗*/
000a06 4EBA FF52       576 jsr UPDATE
                       577 *move.w #0x0800+'e', UTX1
                       578 
                       579 GET_BUF_Finish:
000a0a 4CDF 7E00       580 movem.l (%sp)+, %a1-%a6
000a0e 4E75            581 rts
                       582 
                       583 
                       584 
                       585 
                       586 
                       587 
                       588 
                       589 
                       590 
