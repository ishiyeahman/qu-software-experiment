                         4 .list
                         5 /* *_count の値を変更して繰り返し変え数を決定する */
                         6 .section .data
                         7 .equ IN_COUNT, 257
                         8 .equ OUT_COUNT, 257
                         9 .equ queue_number, 0
                        10 .equ OFFSET_1, 0x100
                        11 .equ END_0, 0xff
                        12 .equ END_1, 0x1ff
00064c 0000 0000        13 top: .ds.b 0x200
       0000 0000        13 
       0000 0000        13 
       0000 0000        13 
       0000 0000        13 
00084c 0000 0000        14 bottom: .ds.w 2
000850 0000 0000        15 in: .ds.l 1
000854 0000 0000        16 in_0: .ds.l 1
000858 0000 0000        17 in_1: .ds.l 1
                        18 
00085c 0000 0000        19 out: .ds.l 1
000860 0000 0000        20 out_0: .ds.l 1
000864 0000 0000        21 out_1: .ds.l 1
                        22 
000868 0000 0000        23 s: .ds.l 1
00086c 0000 0000        24 s0: .ds.l 1
000870 0000 0000        25 s1: .ds.l 1
                        26 
                        27 **PUT_FLG: .ds.b 1
                        28 **PUT_FLG_0: .ds.b 1
                        29 **PUT_FLG_1: .ds.b 1
                        30 
                        31 **GET_FLG: .ds.b 1
                        32 **GET_FLG_0: .ds.b 1
                        33 **GET_FLG_1: .ds.b 1
                        34 
000874 0000 0000        35 START_LABEL: .ds.l 1
                        36 
                        37 .section .text
                        38 
                        39 ** 0x1000からデータを適当に入力する
                        40 ** 0x1300にとりだされたデータが格納される
                        41 ** 0x1600に戻り値1 or 0が格納される
                        42 
                        43 start:
000400 4EBA 0056        44 jsr Init_Q
                        45 
000404 227C 0000        46 move.l #0x1000, %A1
       1000             46 
00040a 247C 0000        47 move.l #0x1300, %A2
       1300             47 
000410 267C 0000        48 move.l #0x1600, %A3
       1600             48 
000416 287C 0000        49 move.l #0x1900, %A4
       1900             49 
00041c 6000 0006        50 bra in_set
                        51 
                        52 finish:
000420 4E72 0A8C        53 stop #2700
                        54 
                        55 
                        56 /* =============================== */
                        57 in_set:
000424 363C 0101        58 move.w #IN_COUNT, %d3
                        59 
                        60 in_loop:
000428 303C 0000        61 move.w #queue_number, %d0
                        62 
                        63 /* 書き込むべきデータを与える */
00042c 1219             64 move.b (%A1)+, %D1
                        65 
00042e 4EBA 0078        66 jsr INQ
                        67 /* 戻り値の格納 */
000432 16C0             68 move.b %D0, (%A3)+
                        69 
000434 5383             70 subq.l #1, %d3
000436 6600 FFF0        71 bne in_loop
00043a 6000 0002        72 bra out_set
                        73 
                        74 /* ================================ */
                        75 
                        76 
                        77 out_set:
00043e 363C 0101        78 move.w #OUT_COUNT, %d3
                        79 
                        80 out_loop:
000442 303C 0000        81 move.w #queue_number, %d0
000446 4EBA 019C        82 jsr OUTQ
                        83 
                        84 /* データと戻り値をメモリに格納しておく*/
00044a 14C1             85 move.b %D1, (%A2)+
00044c 18C0             86 move.b %D0, (%A4)+
                        87 
00044e 5383             88 subq.l #1, %d3
000450 6600 FFF0        89 bne out_loop
000454 6000 FFCA        90 bra finish
                        91 
                        92 
                        93 /* キュー領域の前後での書き込みが発生していないことを確認する*/
                        94 
                        95 
                        96 /* 以下に　INQ と OUTQ を貼り付ける*/
                        97 Init_Q:
000458 48E7 007E        98 movem.l %a1-%a6, -(%sp)
00045c 45F9 0000        99 lea.l top, %a2
       0000             99 
000462 23CA 0000       100 move.l %a2, in_0
       0000            100 
000468 23CA 0000       101 move.l %a2, out_0
       0000            101 
00046e 47EA 0100       102 lea.l OFFSET_1(%a2), %a3
000472 23CB 0000       103 move.l %a3, in_1
       0000            103 
000478 23CB 0000       104 move.l %a3, out_1
       0000            104 
00047e 49F9 0000       105 lea.l s, %a4
       0000            105 
000484 4BF9 0000       106 lea.l s0, %a5
       0000            106 
00048a 4DF9 0000       107 lea.l s1, %a6
       0000            107 
000490 28BC 0000       108 move.l #0,(%a4)
       0000            108 
000496 2ABC 0000       109 move.l #0,(%a5)
       0000            109 
00049c 2CBC 0000       110 move.l #0,(%a6)
       0000            110 
                       111 **move.b #0xff, PUT_FLG_0
                       112 **move.b #0xff, PUT_FLG_1
                       113 **move.b #0x00, GET_FLG_0
                       114 **move.b #0x00, GET_FLG_1
0004a2 4CDF 7E00       115 movem.l (%sp)+, %a1-%a6
0004a6 4E75            116 rts
                       117 
                       118 *****************************************************************
                       119 INQ:
0004a8 4EBA 0008       120 jsr SELECT_QUEUE
0004ac 4EBA 008A       121 jsr PUT_BUF
                       122 
0004b0 4E75            123 rts
                       124 **************************************************************
                       125 SELECT_QUEUE:
0004b2 0C00 0000       126 cmp.b #0, %d0
0004b6 6700 000C       127 beq SET_0
0004ba 0C00 0001       128 cmp.b #1, %d0
0004be 6700 003C       129 beq SET_1
                       130 
                       131 **move.b #0x00, PUT_FLG
                       132 **move.b #0x00, GET_FLG
0004c2 4E75            133 rts
                       134 
                       135 SET_0:
0004c4 48E7 0010       136 movem.l %a3, -(%sp)
0004c8 23F9 0000       137 move.l in_0, in
       0000 0000       137 
       0000            137 
0004d2 23F9 0000       138 move.l out_0, out
       0000 0000       138 
       0000            138 
                       139 **move.b PUT_FLG_0, PUT_FLG
                       140 **move.b GET_FLG_0, GET_FLG
0004dc 23CA 0000       141 move.l %a2, START_LABEL
       0000            141 
0004e2 47EA 00FF       142 lea.l END_0(%a2), %a3
0004e6 23CB 0000       143 move.l %a3, bottom
       0000            143 
0004ec 23F9 0000       144 move.l s0,s
       0000 0000       144 
       0000            144 
0004f6 4CDF 0800       145 movem.l (%sp)+, %a3
0004fa 4E75            146 rts
                       147 
                       148 SET_1:
0004fc 48E7 0010       149 movem.l %a3, -(%sp)
000500 23F9 0000       150 move.l in_1, in
       0000 0000       150 
       0000            150 
00050a 23F9 0000       151 move.l out_1, out
       0000 0000       151 
       0000            151 
                       152 **move.b PUT_FLG_1, PUT_FLG
                       153 **move.b GET_FLG_1, GET_FLG
000514 47EA 0100       154 lea.l OFFSET_1(%a2), %a3
000518 23CB 0000       155 move.l %a3, START_LABEL
       0000            155 
00051e 47EA 01FF       156 lea.l END_1(%a2), %a3
000522 23CB 0000       157 move.l %a3, bottom
       0000            157 
000528 23F9 0000       158 move.l s0,s
       0000 0000       158 
       0000            158 
000532 4CDF 0800       159 movem.l (%sp)+, %a3
000536 4E75            160 rts
                       161 
                       162 *************************************************************************
                       163 
                       164 
                       165 PUT_BUF:
000538 48E7 007E       166 movem.l %a1-%a6, -(%sp)
                       167 
00053c 2439 0000       168 move.l s,%d2
       0000            168 
000542 0C82 0000       169 cmp.l #0x100,%d2
       0100            169 
000548 6700 0042       170 beq PUT_FAIL 
                       171 
00054c 49F9 0000       172 lea.l s,%a4
       0000            172 
000552 5294            173 addq.l #1,(%a4)
000554 143C 0001       174 move.b #1,%d2 /*成功*/
000558 2279 0000       175 movea.l in, %a1
       0000            175 
00055e 12C1            176 move.b %d1, (%a1)+  
                       177 
                       178       
000560 2679 0000       179 move.l bottom, %a3
       0000            179 
000566 B3CB            180 cmpa.l %a3, %a1
000568 6300 000A       181 bls PUT_BUF_STEP1
00056c 2479 0000       182 move.l START_LABEL, %a2
       0000            182 
000572 224A            183 movea.l %a2, %a1
                       184 
                       185 PUT_BUF_STEP1:
000574 23C9 0000       186 move.l %a1, in
       0000            186 
00057a B3F9 0000       187 cmpa.l out, %a1
       0000            187 
000580 6600 0002       188 bne PUT_BUF_STEP2
                       189 **move.b #0x00, PUT_FLG
                       190 
                       191 PUT_BUF_STEP2:
                       192 **move.b #0xff, GET_FLG
000584 4EBA 0010       193 jsr UPDATE
000588 6000 0006       194 bra PUT_BUF_Finish
                       195 
                       196 PUT_FAIL:
00058c 143C 0000       197 move.b #0,%d2 /*失敗*/
                       198 
                       199 PUT_BUF_Finish:
000590 4CDF 7E00       200 movem.l (%sp)+, %a1-%a6
                       201 
000594 4E75            202 rts
                       203 
                       204 ****************************************************************
                       205 
                       206 UPDATE:
000596 0C40 0000       207 cmp #0, %d0
00059a 6700 000C       208 beq QUEUE_0
00059e 0C40 0001       209 cmp #1, %d0
0005a2 6700 0022       210 beq QUEUE_1
0005a6 4E75            211 rts
                       212 
                       213 QUEUE_0:
0005a8 23C9 0000       214 move.l %a1, in_0
       0000            214 
                       215 **move.l in, in_0
                       216 **move.b PUT_FLG, PUT_FLG_0
0005ae 23F9 0000       217 move.l out, out_0
       0000 0000       217 
       0000            217 
                       218 **move.b GET_FLG, GET_FLG_0
0005b8 23F9 0000       219 move.l s,s0
       0000 0000       219 
       0000            219 
0005c2 1002            220 move.b %d2,%d0 /*成功or失敗の返り値*/
                       221 
0005c4 4E75            222 rts
                       223 QUEUE_1:
0005c6 23C9 0000       224 move.l %a1, in_1
       0000            224 
                       225 **move.l in, in_1
                       226 **move.b PUT_FLG, PUT_FLG_1
0005cc 23F9 0000       227 move.l out, out_1
       0000 0000       227 
       0000            227 
                       228 **move.b GET_FLG, GET_FLG_1
0005d6 23F9 0000       229 move.l s,s1
       0000 0000       229 
       0000            229 
0005e0 1002            230 move.b %d2,%d0 /*成功or失敗の返り値*/
0005e2 4E75            231 rts
                       232 
                       233 ********************************************
                       234 OUTQ:
0005e4 4EBA FECC       235 jsr SELECT_QUEUE
0005e8 4EBA 0004       236 jsr GET_BUF
0005ec 4E75            237 rts
                       238 *********************************************
                       239 GET_BUF:
0005ee 48E7 007E       240 movem.l %a1-%a6, -(%sp)
                       241 
0005f2 2439 0000       242 move.l s,%d2
       0000            242 
0005f8 0C82 0000       243 cmp.l #0x00,%d2
       0000            243 
0005fe 6700 0042       244 beq GET_FAIL
                       245 
000602 143C 0001       246 move.b #1,%d2 /*成功*/
000606 49F9 0000       247 lea.l s,%a4
       0000            247 
00060c 5394            248 subq.l #1,(%a4)
00060e 2279 0000       249 movea.l out, %a1
       0000            249 
000614 1219            250 move.b (%a1)+, %d1     
000616 2679 0000       251 move.l bottom, %a3
       0000            251 
00061c B3CB            252 cmpa.l %a3, %a1
00061e 6300 000A       253 bls GET_BUF_STEP1
000622 2479 0000       254 move.l START_LABEL, %a2
       0000            254 
000628 224A            255 movea.l %a2, %a1
                       256 
                       257 GET_BUF_STEP1:
00062a 23C9 0000       258 move.l %a1, out
       0000            258 
000630 B3F9 0000       259 cmpa.l in, %a1
       0000            259 
000636 6600 0002       260 bne GET_BUF_STEP2
                       261 **move.b #0x00, GET_FLG
                       262 
                       263 GET_BUF_STEP2:
                       264 **move.b #0xff, PUT_FLG
00063a 4EBA FF5A       265 jsr UPDATE
00063e 6000 0006       266 bra GET_BUF_Finish
                       267 
                       268 GET_FAIL:
000642 143C 0000       269 move.b #0,%d2 /*失敗*/
                       270 GET_BUF_Finish:
000646 4CDF 7E00       271 movem.l (%sp)+, %a1-%a6
00064a 4E75            272 rts
                       273 
                       274 
                       275 
