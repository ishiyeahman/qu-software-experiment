                         4 .list
                         5 /*以下step8*/
                         6 
                         7 /*trap #0に登録*/
000400 41FA 000A         8 lea.l CALL_SYSTEM, %a0
000404 21C8 0080         9 move.l %a0, 0x080
                        10 
000408 6000 008E        11 bra MAIN		/*step9のMAINへ*/
                        12 
                        13 /*trap #0での処理,SYSTEMCALL*/
                        14 CALL_SYSTEM:
00040c 46FC 2000        15 	move.w #0x2000, %SR
                        16 
000410 0C40 0001        17 	cmpi #1, %d0
000414 6600 000E        18 	bne CALL_PUT
000418 41FA 00F2        19 	lea.l GETSTRING, %a0
00041c 2010             20 	move.l (%a0), %d0
00041e 4ED0             21 	jmp (%a0)
000420 6000 003E        22 	bra CALL_END
                        23 
                        24 CALL_PUT:
000424 0C40 0002        25 	cmpi #2, %d0
000428 6600 000E        26 	bne CALL_RESET
00042c 41FA 00E2        27 	lea.l PUTSTRING, %a0
000430 2010             28 	move.l (%a0), %d0
000432 4ED0             29 	jmp (%a0)
000434 6000 002A        30 	bra CALL_END
                        31 
                        32 CALL_RESET:
000438 0C40 0003        33 	cmpi #3, %d0
00043c 6600 000E        34 	bne CALL_SET
000440 41FA 00D2        35 	lea.l RESET_TIMER, %a0
000444 2010             36 	move.l (%a0), %d0
000446 4ED0             37 	jmp (%a0)
000448 6000 0016        38 	bra CALL_END
                        39 
                        40 CALL_SET:
00044c 0C40 0004        41 	cmpi #4, %d0
000450 6600 000E        42 	bne CALL_END
000454 41FA 00C2        43 	lea.l SET_TIMER, %a0
000458 2010             44 	move.l (%a0), %d0
00045a 4ED0             45 	jmp (%a0)
00045c 6000 0002        46 	bra CALL_END
                        47 
                        48 CALL_END:
000460 4E73             49 	rte
                        50 
                        51 /*各システムの呼び出し,tテストではMAINにあるため使用しない?*/
                        52 /*GETSTRING呼び出し*/
                        53 CALL_GETSTRING:
000462 7001             54 	move.l #1, %d0		/*GETSTRING*/
000464 7200             55 	move.l #0,%d1		/*ch=0*/
000466 243C 0000        56 	move.l #BUF, %d2	/*p=#BUF*/
       0000             56 
00046c 263C 0000        57 	move.l #256, %d3	/*size=256*/
       0100             57 
000472 4E40             58 	trap #0
                        59 
                        60 /*PUTSTRING呼び出し*/
                        61 CALL_PUTSTRING:
000474 7002             62 	move.l #2, %d0		/*PUTSTRING*/
000476 7200             63 	move.l #0,%d1		/*ch=0*/
000478 243C 0000        64 	move.l #BUF, %d2	/*p=#BUF*/
       0000             64 
00047e 263C 0000        65 	move.l #256, %d3	/*size=256*/
       0100             65 
000484 4E40             66 	trap #0
                        67 
                        68 /*RESET_TIMER呼び出し*/
                        69 CALL_RESET_TIMER:
000486 7003             70 	move.l #3, %d0		/*RESET_TIMER*/
000488 4E40             71 	trap #0
                        72 
                        73 /*SET_TIMER呼び出し*/
                        74 CALL_SET_TIMER:
00048a 7004             75 	move.l #4, %d0		/*SET_TIMER*/
00048c 323C 0000        76 	move.w #0,%d1		/*d1=タイマ割り込み発生周期*/
000490 243C 0000        77 	move.l #BUF, %d2	/*p=#BUF*/
       0000             77 
000496 4E40             78 	trap #0
                        79 
                        80 
                        81 /*以上step8*/
                        82 
                        83 
                        84 
                        85 
                        86 
                        87 ******************************************************
                        88 ***システムコール番号
                        89 ******************************************************
                        90 	.equ SYSCALL_NUM_GETSTRING,	1
                        91 	.equ SYSCALL_NUM_PUTSTRING,	2
                        92 	.equ SYSCALL_NUM_RESET_TIMER,	3
                        93 	.equ SYSCALL_NUM_SET_TIMER,	4
                        94 
                        95 
                        96 ******************************************************
                        97 ***プログラム領域
                        98 ******************************************************
                        99 .section .text
                       100 .even
                       101 MAIN:						/*走行モードとレベルの設定(ユーザモードへ移行)*/
                       102 
000498 46FC 0000       103 	move.w #0x0000, %SR				/*USER_MODE_LEBELを0に*/
00049c 4FFA 006A       104 	lea.l USR_STK_TOP, %SP				/*USER_STACKを設定*/
                       105 
                       106 
0004a0 7003            107 	move.l #SYSCALL_NUM_RESET_TIMER, %d0		/*システムコールでRESET_TIMERの起動*/
0004a2 4E40            108 	trap #0
                       109 
                       110 
0004a4 7004            111 	move.l #SYSCALL_NUM_SET_TIMER,%d0		/*システムコールでSET_TIMERの起動*/
0004a6 323C C350       112 	move.w #50000, %d1
0004aa 243C 0000       113 	move.l #TT, %d2
       0000            113 
0004b0 4E40            114 	trap #0
                       115 
                       116 ******************************************************
                       117 ***sys_GETSTRING,SYS_PUTSTRINGのテスト
                       118 ***ターミナルの入力をエコーバック
                       119 ******************************************************
                       120 
                       121 LOOP:
0004b2 7001            122 	move.l #SYSCALL_NUM_GETSTRING, %d0	/*GETSTRINGの呼び出し*/
0004b4 7200            123 	move.l #0, %d1				/*ch=0*/
0004b6 243C 0000       124 	move.l #BUF, %d2			/*p=#BUF*/
       0000            124 
0004bc 263C 0000       125 	move.l #256, %d3			/*size=256*/
       0100            125 
0004c2 4E40            126 	trap #0
                       127 
0004c4 2600            128 	move.l %d0, %d3				/*size=d0*/
0004c6 7002            129 	move.l #SYSCALL_NUM_PUTSTRING, %d0	/*PUTSTRINGの呼び出し*/
0004c8 7200            130 	move.l #0, %d1				/*ch=0*/
0004ca 243C 0000       131 	move.l #BUF, %d2			/*p=#BUF*/
       0000            131 
                       132 
0004d0 6000 FFE0       133 	bra LOOP
                       134 
                       135 ******************************************************
                       136 ***タイマのテスト
                       137 ***'******'を表示し改行
                       138 ***5回実行してRESET_TIMER
                       139 ******************************************************
                       140 
                       141 TT:
0004d4 48E7 FFFE       142 	movem.l %d0-%d7/%a0-%a6,-(%SP)		/*レジスタ退避*/
0004d8 0C79 0005       143 	cmpi.w #5, TTC				/*TTCカウンタで5回実行をカウント*/
       0000 0000       143 
0004e0 6700 001C       144 	beq TTKILL				/*5回実行したらタイマを停止*/
                       145 
0004e4 7002            146 	move.l #SYSCALL_NUM_PUTSTRING, %d0
0004e6 7200            147 move.l #0, %d1					/*ch=0*/
0004e8 243C 0000       148 	move.l #TMSG, %d2			/*p=#TMSG*/
       0000            148 
0004ee 7608            149 	move.l #8, %d3				/*size=8*/
0004f0 4E40            150 	trap #0
                       151 
0004f2 0679 0001       152 	addi.w #1, TTC				/*TTCカウンタを1つ増やす*/
       0000 0000       152 
0004fa 6000 0006       153 	bra TTEND				/*そのまま戻る*/
                       154 
                       155 TTKILL:
0004fe 7003            156 	move.l #SYSCALL_NUM_RESET_TIMER, %d0	/*RESET_TIMERの呼び出し*/
000500 4E40            157 	trap #0
                       158 TTEND:
000502 4CDF 7FFF       159 	movem.l (%SP)+, %d0-%d7/%a0-%a6		/*レジスタ復帰*/
000506 4E75            160 	rts
                       161 
                       162 
                       163 USR_STK_TOP:				/*ユーザスタック領域の最後尾*/
000508 6000 FF56       164 	bra CALL_END	
                       165 
                       166 GETSTRING:
00050c 6000 FF52       167 	bra CALL_END	
                       168 
                       169 
                       170 
                       171 PUTSTRING:
000510 6000 FF4E       172 	bra CALL_END	
                       173 
                       174 
                       175 
                       176 RESET_TIMER:
                       177 	
000514 6000 FF4A       178 	bra CALL_END	
                       179 
                       180 
                       181 
                       182 SET_TIMER:
000518 6000 FF46       183 	bra CALL_END	
                       184 
                       185 
                       186 
                       187 
                       188 ******************************************************
                       189 ***初期化のあるデータ領域
                       190 ******************************************************
                       191 
                       192 .section .data
                       193 TMSG:
00051c 2A2A 2A2A       194 .ascii	"******\r\n"			/*r:行頭へ,n:改行*/
       2A2A 0D0A       194 
                       195 .even
                       196 TTC:
000524 0000            197 .dc.w 0
                       198 .even
                       199 
                       200 ******************************************************
                       201 ***初期化のないデータ領域
                       202 ******************************************************
                       203 .section .bss
                       204 BUF:
000528 0000 0000       205 .ds.b 256				/*BUF[256]*/
       0000 0000       205 
       0000 0000       205 
       0000 0000       205 
       0000 0000       205 
                       206 .even
                       207 
                       208 USR_STK:
000628 0000 0000       209 .ds.b 0x4000				/*ユーザスタック領域*/
       0000 0000       209 
       0000 0000       209 
       0000 0000       209 
       0000 0000       209 
                       210 .even
                       211 
                       212 
                       213 
                       214 
