                         4 .list
                         5 
                         6 .section .data
                         7     *************************
                         8     ** test congfig
                         9     *************************
                        10     /* *_count „ÅÆÂÄ§„ÇíÂ§âÊõ¥„Åó„Å¶Áπ∞„ÇäËøî„ÅóÂ§â„ÅàÊï∞„ÇíÊ±∫ÂÆö„Åô„Çã */
                        11     .equ IN_COUNT, 280
                        12     .equ OUT_COUNT, 280
                        13     .equ queue_number, 0
                        14 
                        15 
                        16     **************************
                        17     ** queue congfig
                        18     **************************
                        19 
                        20 .section .text
                        21 
                        22 ** 0x1000„Åã„Çâ„Éá„Éº„Çø„ÇíÈÅ©ÂΩì„Å´ÂÖ•Âäõ„Åô„Çã
                        23 ** 0x1300„Å´„Å®„Çä„Å†„Åï„Çå„Åü„Éá„Éº„Çø„ÅåÊ†ºÁ¥ç„Åï„Çå„Çã
                        24 ** 0x1600„Å´Êàª„ÇäÂÄ§1 or 0„ÅåÊ†ºÁ¥ç„Åï„Çå„Çã
                        25 
                        26 start:
000400 4EBA 0056        27     jsr Init_Q
                        28 
000404 227C 0000        29     move.l #0x1000, %A1
       1000             29 
00040a 247C 0000        30     move.l #0x1300, %A2
       1300             30 
000410 267C 0000        31     move.l #0x1600, %A3
       1600             31 
000416 287C 0000        32     move.l #0x1900, %A4
       1900             32 
00041c 6000 0006        33     bra in_set
                        34 
                        35 finish:
000420 4E72 0A8C        36     stop #2700
                        37 
                        38 
                        39 /* =============================== */
                        40 in_set:
000424 363C 0118        41     move.w #IN_COUNT, %d3
                        42 
                        43 in_loop:
000428 303C 0000        44     move.w #queue_number, %d0
                        45 
                        46     /* Êõ∏„ÅçËæº„ÇÄ„Åπ„Åç„Éá„Éº„Çø„Çí‰∏é„Åà„Çã */
00042c 1219             47     move.b (%A1)+, %D1
                        48 
00042e 4EBA 006A        49     jsr INQ
                        50     /* Êàª„ÇäÂÄ§„ÅÆÊ†ºÁ¥ç */
000432 26C0             51     move.l %D0, (%A3)+
                        52 
000434 5383             53     subq.l #1, %d3
000436 6600 FFF0        54     bne in_loop
00043a 6000 0002        55     bra out_set
                        56 
                        57 /* ================================ */
                        58 
                        59 
                        60 out_set:
00043e 363C 0118        61     move.w #OUT_COUNT, %d3
                        62 
                        63 out_loop:
000442 303C 0000        64     move.w #queue_number, %d0
000446 4EBA 00A2        65     jsr OUTQ
                        66 
                        67     /* „Éá„Éº„Çø„Å®Êàª„ÇäÂÄ§„Çí„É°„É¢„É™„Å´Ê†ºÁ¥ç„Åó„Å¶„Åä„Åè*/
00044a 14C1             68     move.b %D1, (%A2)+
00044c 28C0             69     move.l %D0, (%A4)+
                        70 
00044e 5383             71     subq.l #1, %d3
000450 6600 FFF0        72     bne out_loop
000454 6000 FFCA        73     bra finish
                        74 
                        75 
                        76 /* „Ç≠„É•„ÉºÈ†òÂüü„ÅÆÂâçÂæå„Åß„ÅÆÊõ∏„ÅçËæº„Åø„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã„Åì„Å®*/
                        77 /* „Ç≠„É•„ÉºÈ†òÂüü„ÅÆÂâçÂæå„Åß„ÅÆÊõ∏„ÅçËæº„Åø„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã„Åì„Å®*/
                        78 *******************************************************
                        79 ** 						QUEUE (TA)
                        80 *******************************************************
                        81 
                        82 
                        83 .section .data
                        84 .equ TOP, 0
                        85 .equ BOTTOM, 4
                        86 .equ IN, 8
                        87 .equ OUT, 12
                        88 .equ S, 16
                        89 .equ DATA_TOP, 18
                        90 .equ DATA_LEN, 256
                        91 .equ QUEUE_SIZE, DATA_TOP + DATA_LEN /* 18 + 256 = 274 */
                        92 
00053c 0000 0000        93 QUEUE_TOP: ds.b QUEUE_SIZE * 2
       0000 0000        93 
       0000 0000        93 
       0000 0000        93 
       0000 0000        93 
                        94 
                        95 /* ÂàùÊúüÂåñ */
                        96 ********************
                        97 * ÂàùÊúüÂåñ
                        98 ********************
                        99 .section .text
                       100 Init_Q:
000458 48E7 C0E0       101     movem.l %d0-%d1/%a0-%a2, -(%sp) /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÈÄÄÈÅø */
                       102 
00045c 7000            103     move.l #0, %d0 /* „Ç≠„É•„ÉºÁï™Âè∑ = 0 */
                       104 
                       105 Init_Q_sub:
00045e 41F9 0000       106     lea.l QUEUE_TOP, %a0 /* „Ç≠„É•„Éº„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
       0000            106 
000464 2200            107     move.l %d0, %d1
000466 C2FC 0112       108     mulu.w #QUEUE_SIZE, %d1 /* „Ç≠„É•„Éºn„ÅÆÁõ∏ÂØæÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = n * („Ç≠„É•„Éº„Çµ„Ç§„Ç∫) */
00046a D1C1            109     add.l %d1, %a0 /* a0 = „Ç≠„É•„Éºn„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
00046c 43E8 0012       110     lea.l DATA_TOP(%a0), %a1 /* a1 = „Ç≠„É•„Éºn„ÅÆ„Éá„Éº„ÇøÈ†òÂüüÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = DATA_TOP + a0
000470 2089            111     move.l %a1, TOP(%a0) /* „Ç≠„É•„Éºn„ÅÆTOP„ÅÆ„Ç¢„Éâ„É¨„Çπ = a0 + TOP „Åß„ÅÇ„Çã„ÅÆ„Åß„Åù„Åì„Å´a1„Ç
000472 2149 0008       112     move.l %a1, IN(%a0) /* „Ç≠„É•„Éºn„ÅÆIN„ÅÆ„Ç¢„Éâ„É¨„Çπ„Å´a1„ÇíÊ†ºÁ¥ç */
000476 2149 000C       113     move.l %a1, OUT(%a0) /* „Ç≠„É•„Éºn„ÅÆOUT„ÅÆ„Ç¢„Éâ„É¨„Çπ„Å´a1„ÇíÊ†ºÁ¥ç */
                       114     
                       115 	
00047a 43E8 0111       116     lea.l QUEUE_SIZE-1(%a0), %a1 /* a1 == BOTTOM = „Ç≠„É•„Éºn„ÅÆÁµÇÁ´Ø„Ç¢„Éâ„É¨„Çπ */
00047e 2149 0004       117     move.l  %a1, BOTTOM(%a0) /* a1 = „Ç≠„É•„Éºn„ÅÆBOTTOM„ÅÆ„Ç¢„Éâ„É¨„Çπ */
                       118 
000482 317C 0000       119     move.w #0, S(%a0) /* „Éá„Éº„ÇøÊï∞ = 0 */
       0010            119 
000488 5280            120     addq.l #1, %d0 /* „Ç≠„É•„ÉºÁï™Âè∑++ */
00048a 0C80 0000       121     cmpi.l #2, %d0 /* „Ç≠„É•„Éº„ÅÆÂÄãÊï∞ÂàÜ(2)„É´„Éº„Éó */
       0002            121 
000490 6600 FFCC       122     bne Init_Q_sub
                       123 
000494 4CDF 0703       124     movem.l (%sp)+, %d0-%d1/%a0-%a2 /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞ */
000498 4E75            125     rts
                       126 
                       127 
                       128 *****************
                       129 ** INQ
                       130 *****************
                       131 
                       132 **************************************
                       133 **ÂÖ•Âäõ
                       134 **  d0:„Ç≠„É•„Éº„ÅÆÈÅ∏Êäû [long]
                       135 **  d1:Êõ∏„ÅçËæº„ÇÄ„Éá„Éº„Çø [long]
                       136 **Âá∫Âäõ
                       137 **  d0:ÊàêÂäü(1)orÂ§±Êïó(0) [long]
                       138 **************************************
                       139 INQ:
                       140 
                       141     /* ÁèæËµ∞Ë°å„É¨„Éô„É´„ÅÆÈÄÄÈÅø */
00049a 40E7            142     move.w %SR, -(%sp)
                       143 
                       144     /* Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢ */
00049c 46FC 2700       145     move.w #0x2700, %SR
                       146 
0004a0 48E7 00C0       147     movem.l %a0-%a1, -(%sp)
0004a4 41F9 0000       148     lea.l QUEUE_TOP, %a0 /* a0 = „Ç≠„É•„Éº0„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
       0000            148 
0004aa C0FC 0112       149     mulu.w #QUEUE_SIZE, %d0 /* „Ç≠„É•„Éºn„ÅÆÁõ∏ÂØæÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = n * („Ç≠„É•„Éº„Çµ„Ç§„Ç∫) */
0004ae D1C0            150     add.l %d0, %a0 /* a0 = „Ç≠„É•„Éºn„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
                       151 
0004b0 0C68 0100       152     cmpi.w #256, S(%a0)
       0010            152 
0004b6 6600 0008       153     bne INQ_1
                       154 
                       155     /* S == 256„ÅÆ„Å®„Åçd0 = 0(Â§±Êïó) „Å®„Åó„Å¶END„Å∏ */
0004ba 7000            156     move.l #0, %d0
0004bc 6000 0024       157     bra INQ_END
                       158 
                       159 INQ_1:
0004c0 2268 0008       160     movea.l IN(%a0), %a1 /* a1 = in */
0004c4 1281            161     move.b %d1, (%a1) /* q[in] = d1 */ 
                       162 
0004c6 B3E8 0004       163     cmpa.l BOTTOM(%a0), %a1 /* in == bottom „Åã„ÇíÂà§ÂÆö */
0004ca 6600 000A       164     bne INQ_ELSE
                       165 
                       166     /* in == bottom „ÅÆ„Å®„Åç*/
0004ce 2150 0008       167     move.l TOP(%a0), IN(%a0) /* in = top */
0004d2 6000 0008       168     bra INQ_2
                       169 
                       170 /* in != bottom „ÅÆ„Å®„Åç*/
                       171 INQ_ELSE:
0004d6 5289            172     addq.l #1, %a1 /* a1++ */
0004d8 2149 0008       173     move.l %a1, IN(%a0) /* in = a1 */
                       174 
                       175 /* s++, d0 = 1(ÊàêÂäü) „Å®„Åó„Å¶END„Å∏ */
                       176 INQ_2:
0004dc 5268 0010       177     addq.w #1, S(%a0)
0004e0 7001            178     move.l #1, %d0
                       179 
                       180 /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞ */
                       181 INQ_END:
0004e2 4CDF 0300       182     movem.l (%sp)+, %a0-%a1 
0004e6 46DF            183     move.w (%sp)+, %SR
0004e8 4E75            184     rts
                       185 
                       186 
                       187 *****************
                       188 * OUTQ
                       189 *****************
                       190 
                       191 **********************************************
                       192 **ÂÖ•Âäõ
                       193 **  d0:„Ç≠„É•„Éº„ÅÆÈÅ∏Êäû  [long]
                       194 
                       195 **Âá∫Âäõ
                       196 **  d0:ÊàêÂäü(1)orÂ§±Êïó(0) [long]
                       197 **  d1:Âèñ„ÇäÁµÑ„Çì„Å†„Éá„Éº„Çø [byte]
                       198 **********************************************
                       199 OUTQ:
                       200     /* ÁèæËµ∞Ë°å„É¨„Éô„É´„ÅÆÈÄÄÈÅø */
0004ea 40E7            201     move.w %SR, -(%sp)
                       202 
                       203     /* Ââ≤„ÇäËæº„ÅøÁ¶ÅÊ≠¢ */
0004ec 46FC 2700       204     move.w #0x2700, %SR
                       205 
0004f0 48E7 00C0       206     movem.l %a0-%a1, -(%sp)
0004f4 41F9 0000       207     lea.l QUEUE_TOP, %a0 /* a0 = „Ç≠„É•„Éº0„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
       0000            207 
0004fa C0FC 0112       208     mulu.w #QUEUE_SIZE, %d0 /* „Ç≠„É•„Éºn„ÅÆÁõ∏ÂØæÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ = n * („Ç≠„É•„Éº„Çµ„Ç§„Ç∫) */
0004fe D1C0            209     add.l %d0, %a0 /* a0 = „Ç≠„É•„Éºn„ÅÆÂÖàÈ†≠„Ç¢„Éâ„É¨„Çπ */
                       210 
000500 0C68 0000       211     cmpi.w #0, S(%a0)
       0010            211 
000506 6600 0008       212     bne OUTQ_1
                       213 
                       214     /* S == 0„ÅÆ„Å®„Åçd0 = 0(Â§±Êïó) „Å®„Åó„Å¶END„Å∏ */
00050a 7000            215     move.l #0, %d0
00050c 6000 0024       216     bra OUTQ_END
                       217 
                       218 OUTQ_1:
000510 2268 000C       219     movea.l OUT(%a0), %a1 /* a1 = out */
000514 1211            220     move.b (%a1), %d1 /* d1 = q[out] */
                       221 
000516 B3E8 0004       222     cmpa.l BOTTOM(%a0), %a1 /* out == bottom „Åã„ÇíÂà§ÂÆö */
00051a 6600 000A       223     bne OUTQ_ELSE
                       224 
                       225     /* out == bottom „ÅÆ„Å®„Åç*/
00051e 2150 000C       226     move.l TOP(%a0), OUT(%a0) /* out = top */
000522 6000 0008       227     bra OUTQ_2
                       228 
                       229 /* out != bottom „ÅÆ„Å®„Åç*/
                       230 OUTQ_ELSE:
000526 5289            231     addq.l #1, %a1 /* a1++ */
000528 2149 000C       232     move.l %a1, OUT(%a0) /* out = a1 */
                       233 
                       234 /* s--, d0 = 1(ÊàêÂäü) „Å®„Åó„Å¶END„Å∏ */
                       235 OUTQ_2:
00052c 5368 0010       236     subq.w #1, S(%a0)
000530 7001            237     move.l #1, %d0
                       238 
                       239 /* ‰ΩøÁî®„É¨„Ç∏„Çπ„Çø„ÅÆÂæ©Â∏∞ */
                       240 OUTQ_END:
000532 4CDF 0300       241     movem.l (%sp)+, %a0-%a1 
000536 46DF            242     move.w (%sp)+, %SR
000538 4E75            243     rts
                       244 
